<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jcmarical.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="引言 偶尔翻到了很早前用DirectX12搭建的渲染器，很多细节都已经遗忘了，现在发上来作为一个参考，期末考完后应该会根据龙书继续学习DX12的细节。  本篇使用DX12，构建了一个加载了光照模型的基础渲染器">
<meta property="og:type" content="article">
<meta property="og:title" content="Direct3D 12 基础渲染器搭建">
<meta property="og:url" content="https://jcmarical.github.io/posts/d3d12-pre.html">
<meta property="og:site_name" content="Maric的博客">
<meta property="og:description" content="引言 偶尔翻到了很早前用DirectX12搭建的渲染器，很多细节都已经遗忘了，现在发上来作为一个参考，期末考完后应该会根据龙书继续学习DX12的细节。  本篇使用DX12，构建了一个加载了光照模型的基础渲染器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721145950240.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721145536444.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721150903460.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721153444722.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721153645480.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230719150935918.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230719202449145.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230719211144048.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230720142427250.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230720223522198.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230722124204513.png">
<meta property="article:published_time" content="2023-12-13T08:31:32.614Z">
<meta property="article:modified_time" content="2023-12-13T08:41:21.005Z">
<meta property="article:author" content="Maric">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721145950240.png">

<link rel="canonical" href="https://jcmarical.github.io/posts/d3d12-pre.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Direct3D 12 基础渲染器搭建 | Maric的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Maric的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">No Code No Life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jcmarical.github.io/posts/d3d12-pre.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/avater_2.jpg">
      <meta itemprop="name" content="Maric">
      <meta itemprop="description" content="街舞、音乐、摄影、Coding······追求一切美好的事物，热爱生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Maric的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Direct3D 12 基础渲染器搭建
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-12-13 16:31:32 / 修改时间：16:41:21" itemprop="dateCreated datePublished" datetime="2023-12-13T16:31:32+08:00">2023-12-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
                </span>
            </span>

          
            <span id="/posts/d3d12-pre.html" class="post-meta-item leancloud_visitors" data-flag-title="Direct3D 12 基础渲染器搭建" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/d3d12-pre.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/d3d12-pre.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>68k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:02</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><blockquote>
<p>偶尔翻到了很早前用DirectX12搭建的渲染器，很多细节都已经遗忘了，现在发上来作为一个参考，期末考完后应该会根据龙书继续学习DX12的细节。</p>
</blockquote>
<p>本篇使用DX12，构建了一个加载了光照模型的基础渲染器</p>
<span id="more"></span>



<h1 id="一-调用D3D12的基本步骤和准备工作"><a href="#一-调用D3D12的基本步骤和准备工作" class="headerlink" title="一 调用D3D12的基本步骤和准备工作"></a>一 调用D3D12的基本步骤和准备工作</h1><h2 id="头文件和引用库文件"><a href="#头文件和引用库文件" class="headerlink" title="头文件和引用库文件"></a>头文件和引用库文件</h2><h3 id="组件对象模型-COM"><a href="#组件对象模型-COM" class="headerlink" title="组件对象模型 COM"></a>组件对象模型 COM</h3><ul>
<li><p>令DirectX不受编程语言束缚，使之向后兼容</p>
</li>
<li><p>通常视为接口，但考虑编程目的，目前当做C++类使用</p>
</li>
<li><p>隐藏大量细节</p>
</li>
<li><p>使用</p>
<ul>
<li>获取指向某COM接口的指针，需要借助特定函数或另一接口的方法，而不是C++的new</li>
<li>COM对象会统计其引用次数（引用计数为0，自行释放内存）</li>
<li>使用完后，应该调用<strong>Release</strong>方法</li>
</ul>
</li>
<li><p>为了辅助管理，Window运行时库（<strong>Windows Runtime Library，WRL</strong>）提供了<code>ComPtr</code>类，可以当做是COM对象的智能指针</p>
<ul>
<li><p><strong>Get：</strong>返回一个指针</p>
</li>
<li><p><strong>GetAddressOf：</strong>返回COM接口指针地址</p>
</li>
<li><p><strong>Reset：</strong>设置为nullptr并释放与之相关的所有引用，与赋值nullptr作用相同</p>
</li>
<li><blockquote>
<p>COM接口都以<strong>大写字母I</strong>开头</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SDKDDKVer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIN32_LEAN_AND_MEAN <span class="comment">// 从 Windows 头中排除极少使用的资料，不加载MFC时使用</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="comment">//添加WTL支持 方便使用COM</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wrl.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Microsoft;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Microsoft::WRL;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dxgi1_6.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DirectXMath.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX;</span><br><span class="line"><span class="comment">//for d3d12</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;d3d12.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;d3d12shader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;d3dcompiler.h&gt;</span></span></span><br><span class="line"><span class="comment">//linker链接库</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;dxguid.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;dxgi.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;d3d12.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;d3dcompiler.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">//Debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dxgidebug.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//将D3D12中的结构都派生（说扩展更合适）为简单的类，以便于使用，加入了构造函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;d3dx12.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GRS_WND_CLASS_NAME _T(<span class="string">&quot;Game Window Class&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GRS_WND_TITLE   _T(<span class="string">&quot;DirectX12 Trigger Sample&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//GRS_THROW_IF_FAILED这个宏其实它就是为了在调用COM接口时简化出错时处理时使用的一个宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GRS_THROW_IF_FAILED(hr) <span class="keyword">if</span> (FAILED(hr))&#123; throw CGRSCOMException(hr); &#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="定义待渲染数据结构（三角形）"><a href="#定义待渲染数据结构（三角形）" class="headerlink" title="定义待渲染数据结构（三角形）"></a>定义待渲染数据结构（三角形）</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">GRS_VERTEX</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//&lt;DirectXMath.h&gt;</span></span><br><span class="line">XMFLOAT3 position; <span class="comment">//float[3]</span></span><br><span class="line">XMFLOAT4 color;   <span class="comment">//float[4]</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UINT nFrameBackBufCount = <span class="number">3u</span>;<span class="comment">//无符号整型</span></span><br><span class="line"></span><br><span class="line">   <span class="type">int</span> iWidth = <span class="number">1024</span>;</span><br><span class="line">   <span class="type">int</span> iHeight = <span class="number">768</span>;  <span class="comment">//窗口大小</span></span><br><span class="line"></span><br><span class="line">   UINT nFrameIndex = <span class="number">0</span>;</span><br><span class="line">   UINT nFrame = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   UINT nDXGIFactoryFlags = <span class="number">0U</span>;</span><br><span class="line">   UINT nRTVDescriptorSize = <span class="number">0U</span>;</span><br><span class="line"></span><br><span class="line">   HWND hWnd = <span class="literal">nullptr</span>; <span class="comment">//窗口句柄</span></span><br><span class="line">   MSG  msg = &#123;&#125;;  <span class="comment">//Message</span></span><br><span class="line"></span><br><span class="line">   <span class="type">float</span> fAspectRatio = <span class="number">3.0f</span>;  <span class="comment">//分辨</span></span><br><span class="line"></span><br><span class="line">   D3D12_VERTEX_BUFFER_VIEW stVertexBufferView = &#123;&#125;;  <span class="comment">//顶点缓冲视图</span></span><br><span class="line"></span><br><span class="line">   UINT64 n64FenceValue = <span class="number">0u</span>i64;      <span class="comment">// ？？？</span></span><br><span class="line"></span><br><span class="line">   HANDLE hFenceEvent = <span class="literal">nullptr</span>;       <span class="comment">//？？？句柄 </span></span><br><span class="line"></span><br><span class="line">   <span class="function">CD3DX12_VIEWPORT <span class="title">stViewPort</span><span class="params">(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="keyword">static_cast</span>&lt;<span class="type">float</span>&gt;(iWidth), <span class="keyword">static_cast</span>&lt;<span class="type">float</span>&gt;(iHeight))</span></span>;</span><br><span class="line">   <span class="function">CD3DX12_RECT  <span class="title">stScissorRect</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">static_cast</span>&lt;LONG&gt;(iWidth), <span class="keyword">static_cast</span>&lt;LONG&gt;(iHeight))</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//ComPtr&lt;&gt; WRL中的智能指针，模版类的析构函数帮助我们来管理这些COM组件实现的接口实例，而无需过多担心内存的泄漏。该智能指针的大小和一般的指针大小是一致的，没有额外的内存空间占用。</span></span><br><span class="line">   ComPtr&lt;IDXGIFactory5&gt;                pIDXGIFactory5; </span><br><span class="line">   ComPtr&lt;IDXGIAdapter1&gt;                pIAdapter;</span><br><span class="line">   ComPtr&lt;ID3D12Device4&gt;                pID3DDevice;</span><br><span class="line">   ComPtr&lt;ID3D12CommandQueue&gt;           pICommandQueue;</span><br><span class="line">   ComPtr&lt;IDXGISwapChain1&gt;              pISwapChain1;</span><br><span class="line">   ComPtr&lt;IDXGISwapChain3&gt;              pISwapChain3;</span><br><span class="line">   ComPtr&lt;ID3D12DescriptorHeap&gt;         pIRTVHeap;</span><br><span class="line">   ComPtr&lt;ID3D12Resource&gt;               pIARenderTargets[nFrameBackBufCount];</span><br><span class="line">   ComPtr&lt;ID3D12CommandAllocator&gt;       pICommandAllocator;</span><br><span class="line">   ComPtr&lt;ID3D12RootSignature&gt;          pIRootSignature;</span><br><span class="line">   ComPtr&lt;ID3D12PipelineState&gt;          pIPipelineState;</span><br><span class="line">   ComPtr&lt;ID3D12GraphicsCommandList&gt;    pICommandList;</span><br><span class="line">   ComPtr&lt;ID3D12Resource&gt;               pIVertexBuffer;</span><br><span class="line">   ComPtr&lt;ID3D12Fence&gt;                  pIFence;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h1 id="二-创建窗口"><a href="#二-创建窗口" class="headerlink" title="二 创建窗口"></a>二 创建窗口</h1><h2 id="WNDCLASSEX"><a href="#WNDCLASSEX" class="headerlink" title="WNDCLASSEX"></a>WNDCLASSEX</h2><h2 id="设置窗口属性"><a href="#设置窗口属性" class="headerlink" title="设置窗口属性"></a>设置窗口属性</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WNDCLASSEX windowClass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	windowClass.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line">	windowClass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">	windowClass.lpfnWndProc = DefWindowProc;</span><br><span class="line">	windowClass.hInstance = hInstance;</span><br><span class="line">	windowClass.hCursor = <span class="built_in">LoadCursor</span>(<span class="literal">NULL</span>, IDC_ARROW);</span><br><span class="line">	windowClass.lpszClassName = <span class="string">L&quot;YSHRenderClass&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="注册WNDCLASSEX结构体"><a href="#注册WNDCLASSEX结构体" class="headerlink" title="注册WNDCLASSEX结构体"></a>注册WNDCLASSEX结构体</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">RegisterClassEx(&amp;<span class="params">windowClass</span>)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Create-Window"><a href="#Create-Window" class="headerlink" title="Create Window"></a>Create Window</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HWND hwnd = <span class="built_in">CreateWindow</span>(</span><br><span class="line">		windowClass.lpszClassName,</span><br><span class="line">		<span class="string">L&quot;YSHRender&quot;</span>,</span><br><span class="line">		WS_OVERLAPPEDWINDOW,</span><br><span class="line">		CW_USEDEFAULT,</span><br><span class="line">		CW_USEDEFAULT,</span><br><span class="line">		<span class="number">800</span>,</span><br><span class="line">		<span class="number">600</span>,</span><br><span class="line">		<span class="literal">nullptr</span>,       </span><br><span class="line">		<span class="literal">nullptr</span>,       </span><br><span class="line">		hInstance,</span><br><span class="line">		<span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Show-Window"><a href="#Show-Window" class="headerlink" title="Show Window"></a>Show Window</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">ShowWindow(<span class="params">hwnd</span>, SW_SHOW)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="添加While循环"><a href="#添加While循环" class="headerlink" title="添加While循环"></a>添加While循环</h2><ul>
<li>持续运行</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="教程一二完整代码"><a href="#教程一二完整代码" class="headerlink" title="?教程一二完整代码"></a><em>?教程一二完整代码</em></h2><ul>
<li>因为未知的错误，所以运行不了</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UINT nFrameBackBufCount = <span class="number">3u</span>;<span class="comment">//无符号整型</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> iWidth = <span class="number">1024</span>;</span><br><span class="line">    <span class="type">int</span> iHeight = <span class="number">768</span>;  <span class="comment">//窗口大小</span></span><br><span class="line"></span><br><span class="line">    UINT nFrameIndex = <span class="number">0</span>;</span><br><span class="line">    UINT nFrame = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    UINT nDXGIFactoryFlags = <span class="number">0U</span>;</span><br><span class="line">    UINT nRTVDescriptorSize = <span class="number">0U</span>;</span><br><span class="line"></span><br><span class="line">    HWND hWnd = <span class="literal">nullptr</span>; <span class="comment">//窗口句柄</span></span><br><span class="line">    MSG  msg = &#123;&#125;;  <span class="comment">//Message</span></span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> fAspectRatio = <span class="number">3.0f</span>;  <span class="comment">//分辨</span></span><br><span class="line"></span><br><span class="line">    D3D12_VERTEX_BUFFER_VIEW stVertexBufferView = &#123;&#125;;  <span class="comment">//顶点缓冲视图</span></span><br><span class="line"></span><br><span class="line">    UINT64 n64FenceValue = <span class="number">0u</span>i64;      <span class="comment">// ？？？</span></span><br><span class="line"></span><br><span class="line">    HANDLE hFenceEvent = <span class="literal">nullptr</span>;       <span class="comment">//？？？句柄 </span></span><br><span class="line"></span><br><span class="line">    <span class="function">CD3DX12_VIEWPORT <span class="title">stViewPort</span><span class="params">(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="keyword">static_cast</span>&lt;<span class="type">float</span>&gt;(iWidth), <span class="keyword">static_cast</span>&lt;<span class="type">float</span>&gt;(iHeight))</span></span>;</span><br><span class="line">    <span class="function">CD3DX12_RECT  <span class="title">stScissorRect</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">static_cast</span>&lt;LONG&gt;(iWidth), <span class="keyword">static_cast</span>&lt;LONG&gt;(iHeight))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ComPtr&lt;&gt; 智能指针，帮助我们来管理这些COM组件实现的接口实例，而无需过多担心内存的泄漏。该智能指针的大小和一般的指针大小是一致的，没有额外的内存空间占用。</span></span><br><span class="line">    ComPtr&lt;IDXGIFactory5&gt;                pIDXGIFactory5; </span><br><span class="line">    ComPtr&lt;IDXGIAdapter1&gt;                pIAdapter;</span><br><span class="line">    ComPtr&lt;ID3D12Device4&gt;                pID3DDevice;</span><br><span class="line">    ComPtr&lt;ID3D12CommandQueue&gt;           pICommandQueue;</span><br><span class="line">    ComPtr&lt;IDXGISwapChain1&gt;              pISwapChain1;</span><br><span class="line">    ComPtr&lt;IDXGISwapChain3&gt;              pISwapChain3;</span><br><span class="line">    ComPtr&lt;ID3D12DescriptorHeap&gt;         pIRTVHeap;</span><br><span class="line">    ComPtr&lt;ID3D12Resource&gt;               pIARenderTargets[nFrameBackBufCount];</span><br><span class="line">    ComPtr&lt;ID3D12CommandAllocator&gt;       pICommandAllocator;</span><br><span class="line">    ComPtr&lt;ID3D12RootSignature&gt;          pIRootSignature;</span><br><span class="line">    ComPtr&lt;ID3D12PipelineState&gt;          pIPipelineState;</span><br><span class="line">    ComPtr&lt;ID3D12GraphicsCommandList&gt;    pICommandList;</span><br><span class="line">    ComPtr&lt;ID3D12Resource&gt;               pIVertexBuffer;</span><br><span class="line">    ComPtr&lt;ID3D12Fence&gt;                  pIFence;</span><br><span class="line"></span><br><span class="line">    WNDCLASSEX windowClass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    windowClass.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line">   <span class="comment">// windowClass.style = CS_HREDRAW | CS_VREDRAW; 不同教程</span></span><br><span class="line">    windowClass.style = CS_GLOBALCLASS;    <span class="comment">//去掉Redraw类型</span></span><br><span class="line">    windowClass.lpfnWndProc = DefWindowProc;</span><br><span class="line">    windowClass.hInstance = hInstance;</span><br><span class="line">    windowClass.hCursor = <span class="built_in">LoadCursor</span>(<span class="literal">NULL</span>, IDC_ARROW);</span><br><span class="line">    windowClass.lpszClassName = <span class="string">L&quot;YSHRenderClass&quot;</span>;</span><br><span class="line">    windowClass.hbrBackground = (HBRUSH)<span class="built_in">GetStockObject</span>(NULL_BRUSH);     <span class="comment">//防止无聊的背景重绘，因为我们并不使用GDI的任何绘制，而是在使用D3D12绘制！</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">RegisterClassEx</span>(&amp;windowClass);</span><br><span class="line"></span><br><span class="line">    hWnd = <span class="built_in">CreateWindowW</span>(GRS_WND_CLASS_NAME</span><br><span class="line">        , GRS_WND_TITLE</span><br><span class="line">        , WS_OVERLAPPED | WS_SYSMENU</span><br><span class="line">        , CW_USEDEFAULT</span><br><span class="line">        , <span class="number">0</span></span><br><span class="line">        , iWidth</span><br><span class="line">        , iHeight</span><br><span class="line">        , <span class="literal">nullptr</span></span><br><span class="line">        , <span class="literal">nullptr</span></span><br><span class="line">        , hInstance</span><br><span class="line">        , <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ShowWindow</span>(hWnd, SW_SHOW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h2 id="添加事件处理"><a href="#添加事件处理" class="headerlink" title="添加事件处理"></a>添加事件处理</h2><ul>
<li>把while改成这个，这下就可以正常关闭窗口了</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MSG msg = &#123;&#125;;</span><br><span class="line">	<span class="keyword">while</span> (msg.message != WM_QUIT)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">PeekMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">			<span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>但VS还没有终止程序，需要添加一个<strong>回调函数</strong>，之前默认的是<strong>DefWindowProc</strong>，现在改成自己的WindowProc函数</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WNDCLASSEX windowClass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	windowClass.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line">	windowClass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">	windowClass.lpfnWndProc = WindowProc;<span class="comment">//DefWindowProc;</span></span><br><span class="line">	windowClass.hInstance = hInstance;</span><br><span class="line">	windowClass.hCursor = <span class="built_in">LoadCursor</span>(<span class="literal">NULL</span>, IDC_ARROW);</span><br><span class="line">	windowClass.lpszClassName = <span class="string">L&quot;YSHRenderClass&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="WindowProc-回调函数"><a href="#WindowProc-回调函数" class="headerlink" title="WindowProc 回调函数"></a>WindowProc 回调函数</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul>
<li>咱们有很多消息类型，通过<code>Switch</code>来选择处理不同类型的信息。</li>
<li>比如<code>WM_DESTROTY</code>，就是在咱们点击关闭窗口按钮时会触发的，在<code>case WM_DESTROY</code>里面咱们调用了<code>PostQuitMessage(0)</code>方法，也就意味着退出了。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (message)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">		<span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三-初始化Direct3D"><a href="#三-初始化Direct3D" class="headerlink" title="三 初始化Direct3D"></a>三 初始化Direct3D</h1><h2 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h2><h3 id="纹理格式"><a href="#纹理格式" class="headerlink" title="纹理格式"></a>纹理格式</h3><ul>
<li>尽管名称在字面上是颜色和Alpha值，但不一定存储的是颜色信息<ul>
<li>如 <strong>1</strong> 还可以储存任意3D向量</li>
<li>也有无类型的纹理，仅用它来预留内存</li>
<li><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721145950240.png" alt="image-20230721145950240"></li>
</ul>
</li>
</ul>
<p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721145536444.png" alt="image-20230721145536444"></p>
<h3 id="深度缓冲"><a href="#深度缓冲" class="headerlink" title="深度缓冲"></a>深度缓冲</h3><p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721150903460.png" alt="image-20230721150903460"></p>
<h3 id="资源与描述符"><a href="#资源与描述符" class="headerlink" title="资源与描述符"></a>资源与描述符</h3><h4 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h4><ul>
<li>GPU会对资源进行读和写操作<ul>
<li>读：例如从纹理或者存有3d场景中几何体位置信息的缓冲区读取数据</li>
<li>写：例如向后台缓冲区或深度&#x2F;模版缓冲区写入数据</li>
</ul>
</li>
<li>在发出绘制命令前，需要将本次draw call相关的Resource bind （or link）到render pipeline。</li>
<li>部分资源可能在每次绘制时发生变化，每次需要重新绑定</li>
</ul>
<h4 id="描述符"><a href="#描述符" class="headerlink" title="描述符"></a>描述符</h4><ul>
<li>然而，GPU资源并非直接与render pipeline 绑定，需要**描述符(descriptor)**对象来对它进行间接引用，descriptor实际上即为一个中间层。</li>
<li>为什么要额外使用这个中间层？<ul>
<li>GPU Resource实际上都是一些普通的内存块</li>
<li>由于Resource通用性，它们能被设置到render pipeline的不同阶段使用<ul>
<li>常见例子：先把纹理用作渲染目标(即D3d绘制到纹理技术)，然后再将该纹理作为一个shader resource（经过采样作为shader的input data）</li>
</ul>
</li>
<li>有时，我们只想bind  a part of resource data 到 render pipeline中</li>
<li>创建一个resource 可能用的 无类型格式，这样GPU甚至不会知晓</li>
</ul>
</li>
<li>作用：<ul>
<li>指定资源数据</li>
<li>为GPU解释资源（无类型，则创建descriptor时指定其type类型）</li>
<li>告知D3D某个资源如何使用</li>
<li>指定resouce的局部数据</li>
</ul>
</li>
</ul>
<h5 id="descriptor-x3D-x3D-view"><a href="#descriptor-x3D-x3D-view" class="headerlink" title="descriptor&#x3D;&#x3D;view"></a>descriptor&#x3D;&#x3D;view<img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721153444722.png" alt="image-20230721153444722"></h5><h4 id="Descriptor具体类型"><a href="#Descriptor具体类型" class="headerlink" title="Descriptor具体类型"></a>Descriptor具体类型</h4><p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230721153645480.png" alt="image-20230721153645480"></p>
<h3 id="描述符堆-Descriptor-Heap"><a href="#描述符堆-Descriptor-Heap" class="headerlink" title="描述符堆 Descriptor Heap"></a>描述符堆 Descriptor Heap</h3><ul>
<li><p>存有一系列描述符，可看做描述符数组</p>
</li>
<li><p>本质上是存放用户程序中某种<strong>特定类型</strong>描述符的一块内存</p>
</li>
<li><p>我们需要为每一种描述符都创建出单独的描述符堆。另外，也可以为同一种描述符类型多个描述符堆</p>
</li>
<li><p>我们可以用多个描述符引用同一个资源</p>
<ul>
<li><p>先把纹理用作渲染目标(即D3d绘制到纹理技术)，然后再将该纹理作为一个shader resource（经过采样作为shader的input data），就要分别创建两个描述符：<strong>RTV描述符和SRV描述符</strong></p>
</li>
<li><p>如果以无类型格式创建一个资源，我们也可以创建两个Descriptor分别根据需求当做浮点值和整数值使用</p>
</li>
</ul>
</li>
</ul>
<p>创建Descriptor最佳时机在初始化期间，此过程中需要执行一些类型的检测和验证工作</p>
<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UINT FrameCount = <span class="number">2</span>;</span><br><span class="line">UINT width = <span class="number">800</span>;</span><br><span class="line">UINT height = <span class="number">600</span>;</span><br><span class="line">HWND hwnd;</span><br></pre></td></tr></table></figure>

<h3 id="管线对象"><a href="#管线对象" class="headerlink" title="管线对象"></a>管线对象</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//管线对象</span></span><br><span class="line">ComPtr&lt;IDXGISwapChain3&gt; swapChain;</span><br><span class="line">ComPtr&lt;ID3D12Device&gt; device;</span><br><span class="line">ComPtr&lt;ID3D12Resource&gt; renderTargets[FrameCount];</span><br><span class="line">ComPtr&lt;ID3D12CommandAllocator&gt; commandAllocator;</span><br><span class="line">ComPtr&lt;ID3D12CommandQueue&gt; commandQueue;</span><br><span class="line">ComPtr&lt;ID3D12DescriptorHeap&gt; rtvHeap;</span><br><span class="line">ComPtr&lt;ID3D12PipelineState&gt; pipelineState;</span><br><span class="line">ComPtr&lt;ID3D12GraphicsCommandList&gt; commandList;</span><br><span class="line">UINT rtvDescriptorSize;</span><br></pre></td></tr></table></figure>

<h3 id="同步对象"><a href="#同步对象" class="headerlink" title="同步对象"></a>同步对象</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UINT frameIndex;</span><br><span class="line">HANDLE fenceEvent;</span><br><span class="line">ComPtr&lt;ID3D12Fence&gt; fence;</span><br><span class="line">UINT64 fenceValue;</span><br></pre></td></tr></table></figure>

<h2 id="加载管线对象"><a href="#加载管线对象" class="headerlink" title="加载管线对象"></a>加载管线对象</h2><ul>
<li>新建一个函数叫<code>LoadPipeline()</code>，下面在这个函数里面加载咱们需要的管线对象了</li>
</ul>
<h3 id="辅助方法（官方抄来-可以自己写"><a href="#辅助方法（官方抄来-可以自己写" class="headerlink" title="辅助方法（官方抄来,可以自己写)"></a>辅助方法（官方抄来,可以自己写)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">HrToString</span><span class="params">(HRESULT hr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> s_str[<span class="number">64</span>] = &#123;&#125;;</span><br><span class="line">	<span class="built_in">sprintf_s</span>(s_str, <span class="string">&quot;HRESULT of 0x%08X&quot;</span>, <span class="built_in">static_cast</span>&lt;UINT&gt;(hr));</span><br><span class="line">	<span class="keyword">return</span> std::<span class="built_in">string</span>(s_str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HrException</span> : <span class="keyword">public</span> std::runtime_error</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">HrException</span>(HRESULT hr) : std::<span class="built_in">runtime_error</span>(<span class="built_in">HrToString</span>(hr)), <span class="built_in">m_hr</span>(hr) &#123;&#125;</span><br><span class="line">	<span class="function">HRESULT <span class="title">Error</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_hr; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">const</span> HRESULT m_hr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThrowIfFailed</span><span class="params">(HRESULT hr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="built_in">HrException</span>(hr);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ID3D12Debug调试层"><a href="#ID3D12Debug调试层" class="headerlink" title="ID3D12Debug	调试层"></a>ID3D12Debug	调试层</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_DEBUG)</span></span><br><span class="line">	&#123;</span><br><span class="line">		ComPtr&lt;ID3D12Debug&gt; debugController;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">SUCCEEDED</span>(<span class="built_in">D3D12GetDebugInterface</span>(<span class="built_in">IID_PPV_ARGS</span>(&amp;debugController))))</span><br><span class="line">		&#123;</span><br><span class="line">			debugController-&gt;<span class="built_in">EnableDebugLayer</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<h3 id="IDXGIFactory4-枚举显示适配器，创建交换链"><a href="#IDXGIFactory4-枚举显示适配器，创建交换链" class="headerlink" title="IDXGIFactory4 枚举显示适配器，创建交换链"></a>IDXGIFactory4 枚举显示适配器，创建交换链</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ComPtr&lt;IDXGIFactory4&gt; mDxgiFactory;				<span class="built_in">ThrowIfFailed</span>(<span class="built_in">CreateDXGIFactory1</span>(<span class="built_in">IID_PPV_ARGS</span>(mDxgiFactory.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>

<h4 id="IDXGIAdapter1"><a href="#IDXGIAdapter1" class="headerlink" title="IDXGIAdapter1"></a>IDXGIAdapter1</h4><ul>
<li>不只1，还有2、3、4</li>
<li>现在可以通过上面创建的工厂来枚举咱们的适配器了</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IDXGIAdapter1* <span class="title">GetSupportedAdapter</span><span class="params">(ComPtr&lt;IDXGIFactory4&gt;&amp; dxgiFactory,<span class="type">const</span> D3D_FEATURE_LEVEL featureLevel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IDXGIAdapter1* adapter = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">for</span> (std::<span class="type">uint32_t</span> adapterIndex = <span class="number">0U</span>; ; ++adapterIndex) </span><br><span class="line">	&#123;</span><br><span class="line">		IDXGIAdapter1* currentAdapter = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (DXGI_ERROR_NOT_FOUND == dxgiFactory-&gt;<span class="built_in">EnumAdapters1</span>(adapterIndex, &amp;currentAdapter)) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> HRESULT hres = <span class="built_in">D3D12CreateDevice</span>(currentAdapter,featureLevel,_uuidof(ID3D12Device),<span class="literal">nullptr</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">SUCCEEDED</span>(hres)) </span><br><span class="line">		&#123;</span><br><span class="line">			adapter = currentAdapter;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		currentAdapter-&gt;<span class="built_in">Release</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>找到咱们支持的适配器</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">D3D_FEATURE_LEVEL featureLevels[] =</span><br><span class="line">	&#123;</span><br><span class="line">		D3D_FEATURE_LEVEL_12_1,</span><br><span class="line">		D3D_FEATURE_LEVEL_12_0,</span><br><span class="line">		D3D_FEATURE_LEVEL_11_1,</span><br><span class="line">		D3D_FEATURE_LEVEL_11_0,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	IDXGIAdapter1* adapter = nullptr;</span><br><span class="line">	for (std::uint32_t i = 0U; i &lt; _countof(featureLevels); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		adapter = GetSupportedAdapter(mDxgiFactory, featureLevels[i]);</span><br><span class="line">		if (adapter != nullptr) </span><br><span class="line">		&#123;</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ID3D12Device-包含对象创建方法"><a href="#ID3D12Device-包含对象创建方法" class="headerlink" title="ID3D12Device 包含对象创建方法"></a>ID3D12Device 包含对象创建方法</h3><ul>
<li><code>ID3D12Device</code>接口作为最基础的接口之一，在整个d3d12编程中有很重要的作用。包含了很多重要对象的创建方法。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (adapter != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">D3D12CreateDevice</span>(adapter,D3D_FEATURE_LEVEL_12_1,<span class="built_in">IID_PPV_ARGS</span>(device.<span class="built_in">GetAddressOf</span>()));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ID3D12CommandQueue-命令队列"><a href="#ID3D12CommandQueue-命令队列" class="headerlink" title="ID3D12CommandQueue 命令队列"></a>ID3D12CommandQueue 命令队列</h3><ul>
<li>在Direct3D12中，命令队列由接口<code>ID3D12CommandQueue</code>来表示。它是通过填充<code>D3D12_COMMAND_QUEUE_DESC</code>结构来描述队列，然后调用<code>ID3D12Device::CreateCommandQueue</code>来创建的。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">	queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">	queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;commandQueue)));</span><br></pre></td></tr></table></figure>

<h3 id="IDXGISwapChain3-交换链"><a href="#IDXGISwapChain3-交换链" class="headerlink" title="IDXGISwapChain3 交换链"></a>IDXGISwapChain3 交换链</h3><ul>
<li>正如你看到的，它带了个数字3，也就意味着还有。。。</li>
</ul>
<h4 id="交换链和页面翻转"><a href="#交换链和页面翻转" class="headerlink" title="交换链和页面翻转"></a>交换链和页面翻转</h4><p>为避免动画中画面闪烁，最好将动画帧绘制在一中称为后台缓冲区的离屏(off-screen)纹理内。</p>
<ul>
<li>后台缓冲区绘制完后，和前台缓冲区互换的操作，称为<strong>呈现</strong>，只需交换两个指针即可</li>
<li>后台缓冲区和前台缓冲区构成了<strong>交换链</strong>(swap chain)</li>
<li>使用两个缓冲区称为<strong>双缓冲</strong>(double buffering)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DXGI_SWAP_CHAIN_DESC1 swapChainDesc = &#123;&#125;;</span><br><span class="line">	swapChainDesc.BufferCount = FrameCount;</span><br><span class="line">	swapChainDesc.Width = width;</span><br><span class="line">	swapChainDesc.Height = height;</span><br><span class="line">	swapChainDesc.Format = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">	swapChainDesc.BufferUsage = DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">	swapChainDesc.SwapEffect = DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">	swapChainDesc.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	ComPtr&lt;IDXGISwapChain1&gt; swapChain1;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mDxgiFactory-&gt;<span class="built_in">CreateSwapChainForHwnd</span>(</span><br><span class="line">		commandQueue.<span class="built_in">Get</span>(),  </span><br><span class="line">		hwnd,</span><br><span class="line">		&amp;swapChainDesc,</span><br><span class="line">		<span class="literal">nullptr</span>,</span><br><span class="line">		<span class="literal">nullptr</span>,</span><br><span class="line">		&amp;swapChain1</span><br><span class="line">	));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(swapChain1.<span class="built_in">As</span>(&amp;swapChain));</span><br><span class="line">	frameIndex = swapChain-&gt;<span class="built_in">GetCurrentBackBufferIndex</span>();</span><br></pre></td></tr></table></figure>

<h3 id="ID3D12DescriptorHeap-描述符堆"><a href="#ID3D12DescriptorHeap-描述符堆" class="headerlink" title="ID3D12DescriptorHeap 描述符堆"></a>ID3D12DescriptorHeap 描述符堆</h3><ul>
<li>描述符堆是什么？看名字就知道是存放东西的地方，每错，它就是用来存放描述符（内存那么多数据，我怎么知道这块内存是什么？就靠描述符来对它描述）或者说是资源视图的。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc = &#123;&#125;;</span><br><span class="line">		rtvHeapDesc.NumDescriptors = FrameCount;</span><br><span class="line">		rtvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">		rtvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;rtvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;rtvHeap)));</span><br><span class="line"></span><br><span class="line">		rtvDescriptorSize = device-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br></pre></td></tr></table></figure>

<h3 id="ID3D12Resource-资源"><a href="#ID3D12Resource-资源" class="headerlink" title="ID3D12Resource 资源"></a>ID3D12Resource 资源</h3><ul>
<li>首先通过<code>GetBuffer</code>方法获取交换链缓存区资源，然后为此资源创建视图。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (UINT n = <span class="number">0</span>; n &lt; FrameCount; n++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(swapChain-&gt;<span class="built_in">GetBuffer</span>(n, <span class="built_in">IID_PPV_ARGS</span>(&amp;renderTargets[n])));</span><br><span class="line">		device-&gt;<span class="built_in">CreateRenderTargetView</span>(renderTargets[n].<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, rtvHandle);</span><br><span class="line">		rtvHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, rtvDescriptorSize);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ID3D12CommandAllocator-命令分配器"><a href="#ID3D12CommandAllocator-命令分配器" class="headerlink" title="ID3D12CommandAllocator 命令分配器"></a>ID3D12CommandAllocator 命令分配器</h3><ul>
<li>创建命令分配器来存放命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommandAllocator</span>(D3D12_COMMAND_LIST_TYPE_DIRECT, <span class="built_in">IID_PPV_ARGS</span>(&amp;commandAllocator)));</span><br></pre></td></tr></table></figure>

<h3 id="LoadPipeline方法完整代码"><a href="#LoadPipeline方法完整代码" class="headerlink" title="LoadPipeline方法完整代码"></a>LoadPipeline方法完整代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadPipeline</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_DEBUG)</span></span><br><span class="line">	&#123;</span><br><span class="line">		ComPtr&lt;ID3D12Debug&gt; debugController;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">SUCCEEDED</span>(<span class="built_in">D3D12GetDebugInterface</span>(<span class="built_in">IID_PPV_ARGS</span>(&amp;debugController))))</span><br><span class="line">		&#123;</span><br><span class="line">			debugController-&gt;<span class="built_in">EnableDebugLayer</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line"></span><br><span class="line">	ComPtr&lt;IDXGIFactory4&gt; mDxgiFactory;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(<span class="built_in">CreateDXGIFactory1</span>(<span class="built_in">IID_PPV_ARGS</span>(mDxgiFactory.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	D3D_FEATURE_LEVEL featureLevels[] =</span><br><span class="line">	&#123;</span><br><span class="line">		D3D_FEATURE_LEVEL_12_1,</span><br><span class="line">		D3D_FEATURE_LEVEL_12_0,</span><br><span class="line">		D3D_FEATURE_LEVEL_11_1,</span><br><span class="line">		D3D_FEATURE_LEVEL_11_0,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	IDXGIAdapter1* adapter = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">for</span> (std::<span class="type">uint32_t</span> i = <span class="number">0U</span>; i &lt; _countof(featureLevels); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		adapter = <span class="built_in">GetSupportedAdapter</span>(mDxgiFactory, featureLevels[i]);</span><br><span class="line">		<span class="keyword">if</span> (adapter != <span class="literal">nullptr</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (adapter != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">D3D12CreateDevice</span>(adapter,D3D_FEATURE_LEVEL_12_1,<span class="built_in">IID_PPV_ARGS</span>(device.<span class="built_in">GetAddressOf</span>()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">	queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">	queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;commandQueue)));</span><br><span class="line"></span><br><span class="line">	DXGI_SWAP_CHAIN_DESC1 swapChainDesc = &#123;&#125;;</span><br><span class="line">	swapChainDesc.BufferCount = FrameCount;</span><br><span class="line">	swapChainDesc.Width = width;</span><br><span class="line">	swapChainDesc.Height = height;</span><br><span class="line">	swapChainDesc.Format = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">	swapChainDesc.BufferUsage = DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">	swapChainDesc.SwapEffect = DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">	swapChainDesc.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	ComPtr&lt;IDXGISwapChain1&gt; swapChain1;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mDxgiFactory-&gt;<span class="built_in">CreateSwapChainForHwnd</span>(</span><br><span class="line">		commandQueue.<span class="built_in">Get</span>(),  </span><br><span class="line">		hwnd,</span><br><span class="line">		&amp;swapChainDesc,</span><br><span class="line">		<span class="literal">nullptr</span>,</span><br><span class="line">		<span class="literal">nullptr</span>,</span><br><span class="line">		&amp;swapChain1</span><br><span class="line">	));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(swapChain1.<span class="built_in">As</span>(&amp;swapChain));</span><br><span class="line">	frameIndex = swapChain-&gt;<span class="built_in">GetCurrentBackBufferIndex</span>();</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc = &#123;&#125;;</span><br><span class="line">		rtvHeapDesc.NumDescriptors = FrameCount;</span><br><span class="line">		rtvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">		rtvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;rtvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;rtvHeap)));</span><br><span class="line"></span><br><span class="line">		rtvDescriptorSize = device-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHandle</span><span class="params">(rtvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (UINT n = <span class="number">0</span>; n &lt; FrameCount; n++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(swapChain-&gt;<span class="built_in">GetBuffer</span>(n, <span class="built_in">IID_PPV_ARGS</span>(&amp;renderTargets[n])));</span><br><span class="line">		device-&gt;<span class="built_in">CreateRenderTargetView</span>(renderTargets[n].<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, rtvHandle);</span><br><span class="line">		rtvHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, rtvDescriptorSize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommandAllocator</span>(D3D12_COMMAND_LIST_TYPE_DIRECT, <span class="built_in">IID_PPV_ARGS</span>(&amp;commandAllocator)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="加载资源对象"><a href="#加载资源对象" class="headerlink" title="加载资源对象"></a>加载资源对象</h2><ul>
<li><p>新建LoadAsset(),下面在这个函数中加载咱们需要的资源</p>
</li>
<li><p>因为咱们现在只是初始化DX而已，并不需要什么资源，所以此方法内容比较简单。</p>
</li>
<li><p>首先前面创建的命令列表在记录命令前得先关闭，然后创建了CPU和GPU同步的Fence。</p>
</li>
<li><p>&#96;&#96;&#96;cpp<br>void LoadAsset()<br>{<br>ThrowIfFailed(device-&gt;CreateCommandList(0, D3D12_COMMAND_LIST_TYPE_DIRECT, commandAllocator.Get(), nullptr, IID_PPV_ARGS(&amp;commandList)));<br><br>ThrowIfFailed(commandList-&gt;Close());&#x2F;&#x2F;关闭命令队列<br><br>{<br>    ThrowIfFailed(device-&gt;CreateFence(0, D3D12_FENCE_FLAG_NONE, IID_PPV_ARGS(&amp;fence)));<br>    fenceValue &#x3D; 1;<br><br>    fenceEvent &#x3D; CreateEvent(nullptr, FALSE, FALSE, nullptr);<br>    if (fenceEvent &#x3D;&#x3D; nullptr)<br>    {<br>        ThrowIfFailed(HRESULT_FROM_WIN32(GetLastError()));<br>    }<br>}<br>}</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 添加命令<span class="operator"></span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">* </span>创建一个新的方法<span class="constructor">`PopulateCommandList()</span>`来记录命令，这里执行了一个最简单操作`ClearRenderTargetView`。</span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line">void <span class="constructor">PopulateCommandList()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="constructor">ThrowIfFailed(<span class="params">commandAllocator</span>-&gt;Reset()</span>);</span><br><span class="line">	<span class="constructor">ThrowIfFailed(<span class="params">commandList</span>-&gt;Reset(<span class="params">commandAllocator</span>.Get()</span>, pipelineState.<span class="constructor">Get()</span>));</span><br><span class="line"></span><br><span class="line">	D3D12_RESOURCE_BARRIER resBarrier = CD3DX12_RESOURCE_BARRIER::<span class="constructor">Transition(<span class="params">renderTargets</span>[<span class="params">frameIndex</span>].Get()</span>, D3D12_RESOURCE_STATE_PRESENT, D3D12_RESOURCE_STATE_RENDER_TARGET);</span><br><span class="line">	commandList-&gt;<span class="constructor">ResourceBarrier(1, &amp;<span class="params">resBarrier</span>)</span>;</span><br><span class="line"></span><br><span class="line">	CD3DX12_CPU_DESCRIPTOR_HANDLE rtv<span class="constructor">Handle(<span class="params">rtvHeap</span>-&gt;GetCPUDescriptorHandleForHeapStart()</span>, frameIndex, rtvDescriptorSize);</span><br><span class="line"></span><br><span class="line">	const <span class="built_in">float</span> clearColor<span class="literal">[]</span> = &#123; <span class="number">0.0</span>f, <span class="number">0.2</span>f, <span class="number">0.4</span>f, <span class="number">1.0</span>f &#125;;</span><br><span class="line">	commandList-&gt;<span class="constructor">ClearRenderTargetView(<span class="params">rtvHandle</span>, <span class="params">clearColor</span>, 0, <span class="params">nullptr</span>)</span>;</span><br><span class="line"></span><br><span class="line">	resBarrier = CD3DX12_RESOURCE_BARRIER::<span class="constructor">Transition(<span class="params">renderTargets</span>[<span class="params">frameIndex</span>].Get()</span>, D3D12_RESOURCE_STATE_RENDER_TARGET, D3D12_RESOURCE_STATE_PRESENT);</span><br><span class="line">	commandList-&gt;<span class="constructor">ResourceBarrier(1, &amp;<span class="params">resBarrier</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="constructor">ThrowIfFailed(<span class="params">commandList</span>-&gt;Close()</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><ul>
<li>创建一个新的方法WaitForPreviousFrame()来进行同步。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WaitForPreviousFrame</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">const</span> UINT64 tempFenceValue = fenceValue;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(commandQueue-&gt;<span class="built_in">Signal</span>(fence.<span class="built_in">Get</span>(), tempFenceValue));</span><br><span class="line">	fenceValue++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fence-&gt;<span class="built_in">GetCompletedValue</span>() &lt; tempFenceValue)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(fence-&gt;<span class="built_in">SetEventOnCompletion</span>(tempFenceValue, fenceEvent));</span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(fenceEvent, INFINITE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	frameIndex = swapChain-&gt;<span class="built_in">GetCurrentBackBufferIndex</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h2><ul>
<li><p>创建一个新的方法<code>OnRender()</code>来渲染。</p>
</li>
<li><p>&#96;&#96;&#96;cpp<br>void OnRender()<br>{<br>PopulateCommandList();<br><br>ID3D12CommandList* ppCommandLists[] &#x3D; { commandList.Get() };<br>commandQueue-&gt;ExecuteCommandLists(_countof(ppCommandLists), ppCommandLists);<br><br>ThrowIfFailed(swapChain-&gt;Present(1, 0));<br><br>WaitForPreviousFrame();<br>}</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 清理</span><br><span class="line"></span><br><span class="line">* 创建一个新的方法<span class="built_in">OnDestroy</span>()来清理。</span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line">void <span class="built_in">OnDestroy</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">WaitForPreviousFrame</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(fenceEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="渲染-1"><a href="#渲染-1" class="headerlink" title="渲染"></a>渲染</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">PopulateCommandList</span>();</span><br><span class="line"></span><br><span class="line">	ID3D12CommandList* ppCommandLists[] = &#123; commandList.<span class="built_in">Get</span>() &#125;;</span><br><span class="line">	commandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(ppCommandLists), ppCommandLists);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(swapChain-&gt;<span class="built_in">Present</span>(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WaitForPreviousFrame</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WindowProc"><a href="#WindowProc" class="headerlink" title="WindowProc"></a>WindowProc</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (message)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> WM_PAINT:</span><br><span class="line">		<span class="built_in">OnRender</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">		<span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hWnd, message, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Main函数也要修改"><a href="#Main函数也要修改" class="headerlink" title="Main函数也要修改"></a>Main函数也要修改</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> CALLBACK <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ LPSTR lpCmdLine, _In_ <span class="type">int</span> nShowCmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WNDCLASSEX windowClass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	windowClass.cbSize = <span class="built_in">sizeof</span>(WNDCLASSEX);</span><br><span class="line">	windowClass.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">	windowClass.lpfnWndProc = WindowProc;</span><br><span class="line">	windowClass.hInstance = hInstance;</span><br><span class="line">	windowClass.hCursor = <span class="built_in">LoadCursor</span>(<span class="literal">NULL</span>, IDC_ARROW);</span><br><span class="line">	windowClass.lpszClassName = <span class="string">L&quot;YSHRenderClass&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RegisterClassEx</span>(&amp;windowClass);</span><br><span class="line"></span><br><span class="line">	hwnd = <span class="built_in">CreateWindow</span>(</span><br><span class="line">		windowClass.lpszClassName,</span><br><span class="line">		<span class="string">L&quot;YSHRender&quot;</span>,</span><br><span class="line">		WS_OVERLAPPEDWINDOW,</span><br><span class="line">		CW_USEDEFAULT,</span><br><span class="line">		CW_USEDEFAULT,</span><br><span class="line">		width,</span><br><span class="line">		height,</span><br><span class="line">		<span class="literal">nullptr</span>,</span><br><span class="line">		<span class="literal">nullptr</span>,</span><br><span class="line">		hInstance,</span><br><span class="line">		<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">LoadPipeline</span>();</span><br><span class="line">	<span class="built_in">LoadAsset</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ShowWindow</span>(hwnd, SW_SHOW);</span><br><span class="line"></span><br><span class="line">	MSG msg = &#123;&#125;;</span><br><span class="line">	<span class="keyword">while</span> (msg.message != WM_QUIT)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">PeekMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">			<span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">OnDestroy</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四-背景颜色更新"><a href="#四-背景颜色更新" class="headerlink" title="四 背景颜色更新"></a>四 背景颜色更新</h1><h2 id="全局变量-RGB颜色"><a href="#全局变量-RGB颜色" class="headerlink" title="全局变量:RGB颜色"></a>全局变量:RGB颜色</h2><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RGB颜色</span></span><br><span class="line"><span class="built_in">float</span> color[<span class="number">4</span>];</span><br><span class="line"><span class="built_in">bool</span> isRAdd = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">bool</span> isGAdd = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">bool</span> isBAdd = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<h2 id="清屏颜色设置"><a href="#清屏颜色设置" class="headerlink" title="清屏颜色设置"></a>清屏颜色设置</h2><ul>
<li><p>我们需要将添加命令函数<code>PopulateCommandList()</code>里的<code>clearColor</code>修改为全局变量</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="type">float</span> clearColor[] = &#123; <span class="type">color</span>[<span class="number">0</span>], <span class="type">color</span>[<span class="number">1</span>], <span class="type">color</span>[<span class="number">2</span>], <span class="type">color</span>[<span class="number">3</span>] &#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="添加Update函数"><a href="#添加Update函数" class="headerlink" title="添加Update函数"></a>添加Update函数</h2><ul>
<li>该功能实现窗口颜色的变化</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (color[<span class="number">0</span>] &lt;= <span class="number">1.0f</span> &amp;&amp; isRAdd)</span><br><span class="line">	&#123;</span><br><span class="line">		color[<span class="number">0</span>] += <span class="number">0.001f</span>;</span><br><span class="line">		isRAdd = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		color[<span class="number">0</span>] -= <span class="number">0.002f</span>;</span><br><span class="line">		color[<span class="number">0</span>] &lt;= <span class="number">0</span> ? isRAdd = <span class="literal">true</span> : isRAdd = <span class="literal">false</span>;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (color[<span class="number">1</span>] &lt;= <span class="number">1.0f</span> &amp;&amp; isGAdd)</span><br><span class="line">	&#123;</span><br><span class="line">		color[<span class="number">1</span>] += <span class="number">0.002f</span>;</span><br><span class="line">		isGAdd = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		color[<span class="number">1</span>] -= <span class="number">0.001f</span>;</span><br><span class="line">		color[<span class="number">1</span>] &lt;= <span class="number">0</span> ? isGAdd = <span class="literal">true</span> : isGAdd = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (color[<span class="number">2</span>] &lt;= <span class="number">1.0f</span> &amp;&amp; isBAdd)</span><br><span class="line">	&#123;</span><br><span class="line">		color[<span class="number">2</span>] += <span class="number">0.001f</span>;</span><br><span class="line">		isBAdd = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		color[<span class="number">2</span>] -= <span class="number">0.001f</span>;</span><br><span class="line">		color[<span class="number">2</span>] &lt;= <span class="number">0</span> ? isBAdd = <span class="literal">true</span> : isBAdd = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	color[<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><ul>
<li>我们需要执行我们刚才新增的<code>OnUpdate()</code>函数</li>
</ul>
<blockquote>
<p>最后，我们就可以得到一个窗口不断变化背景颜色的程序了</p>
</blockquote>
<h1 id="五-绘制三角形"><a href="#五-绘制三角形" class="headerlink" title="五 绘制三角形"></a>五 绘制三角形</h1><h2 id="修改LoadAsset方法"><a href="#修改LoadAsset方法" class="headerlink" title="修改LoadAsset方法"></a>修改<code>LoadAsset</code>方法</h2><ul>
<li>只需要修改一下<code>LoadAsset</code>方法</li>
</ul>
<h2 id="根签名-ID3D12RootSignature"><a href="#根签名-ID3D12RootSignature" class="headerlink" title="根签名 ID3D12RootSignature"></a>根签名 ID3D12RootSignature</h2><h3 id="什么是根签名？"><a href="#什么是根签名？" class="headerlink" title="什么是根签名？"></a>什么是根签名？</h3><p>根签名由应用配置，并将命令列表链接到着色器所需的资源。 图形命令列表同时具有图形和计算根签名。 计算命令列表只具有一个计算根签名。 这些根签名彼此独立。</p>
<p>详细请看<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/direct3d12/root-signatures">根签名 - Win32 apps | Microsoft Learn</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		CD3DX12_ROOT_SIGNATURE_DESC rootSignatureDesc;</span><br><span class="line">		rootSignatureDesc.<span class="built_in">Init</span>(<span class="number">0</span>, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>, D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT);</span><br><span class="line"></span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; signature;</span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; error;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3D12SerializeRootSignature</span>(&amp;rootSignatureDesc, D3D_ROOT_SIGNATURE_VERSION_1, &amp;signature, &amp;error));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateRootSignature</span>(<span class="number">0</span>, signature-&gt;<span class="built_in">GetBufferPointer</span>(), signature-&gt;<span class="built_in">GetBufferSize</span>(), <span class="built_in">IID_PPV_ARGS</span>(&amp;rootSignature)));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第一个着色器"><a href="#第一个着色器" class="headerlink" title="第一个着色器"></a>第一个着色器</h2><h3 id="引入新的头文件（d3dcompiler-h）和库（d3dcompiler-lib）。"><a href="#引入新的头文件（d3dcompiler-h）和库（d3dcompiler-lib）。" class="headerlink" title="引入新的头文件（d3dcompiler.h）和库（d3dcompiler.lib）。"></a>引入新的头文件（d3dcompiler.h）和库（d3dcompiler.lib）。</h3><h3 id="第一个shader"><a href="#第一个shader" class="headerlink" title="第一个shader"></a>第一个shader</h3><ul>
<li>新建一个<strong>Assets文件夹</strong>存放着色器文件，然后新建一个**<code>shaders.hlsl</code>**文件。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">     ComPtr&lt;ID3DBlob&gt; vertexShader;</span><br><span class="line">        ComPtr&lt;ID3DBlob&gt; pixelShader;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_DEBUG)</span></span><br><span class="line">        <span class="comment">// Enable better shader debugging with the graphics debugging tools.</span></span><br><span class="line">        UINT compileFlags = D3DCOMPILE_DEBUG | D3DCOMPILE_SKIP_OPTIMIZATION;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        UINT compileFlags = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DCompileFromFile</span>(<span class="built_in">GetAssetFullPath</span>(<span class="string">L&quot;shaders.hlsl&quot;</span>).<span class="built_in">c_str</span>(), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="string">&quot;VSMain&quot;</span>, <span class="string">&quot;vs_5_0&quot;</span>, compileFlags, <span class="number">0</span>, &amp;vertexShader, <span class="literal">nullptr</span>));</span><br><span class="line">        <span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DCompileFromFile</span>(<span class="built_in">GetAssetFullPath</span>(<span class="string">L&quot;shaders.hlsl&quot;</span>).<span class="built_in">c_str</span>(), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="string">&quot;PSMain&quot;</span>, <span class="string">&quot;ps_5_0&quot;</span>, compileFlags, <span class="number">0</span>, &amp;pixelShader, <span class="literal">nullptr</span>));</span><br></pre></td></tr></table></figure>

<h4 id="shaders-hlsl"><a href="#shaders-hlsl" class="headerlink" title="shaders.hlsl"></a><strong><code>shaders.hlsl</code></strong></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PSInput</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float4 color : COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PSInput <span class="title">VSMain</span><span class="params">(float4 position : POSITION, float4 color : COLOR)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSInput result;</span><br><span class="line"></span><br><span class="line">    result.position = position;</span><br><span class="line">    result.color = color;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PSMain</span><span class="params">(PSInput input)</span> : SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> input.color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建管线状态对象-ID3D12PipelineState"><a href="#创建管线状态对象-ID3D12PipelineState" class="headerlink" title="创建管线状态对象 ID3D12PipelineState"></a>创建管线状态对象 ID3D12PipelineState</h2><h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><ul>
<li>表示当前设置的所有着色器和某些固定函数状态对象的状态</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">D3D12_INPUT_ELEMENT_DESC inputElementDescs[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">			&#123; <span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		D3D12_GRAPHICS_PIPELINE_STATE_DESC psoDesc = &#123;&#125;;</span><br><span class="line">		psoDesc.InputLayout = &#123; inputElementDescs, _countof(inputElementDescs) &#125;;</span><br><span class="line">		psoDesc.pRootSignature = rootSignature.<span class="built_in">Get</span>();</span><br><span class="line">		psoDesc.VS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(vertexShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.PS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(pixelShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.RasterizerState = <span class="built_in">CD3DX12_RASTERIZER_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.BlendState = <span class="built_in">CD3DX12_BLEND_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.DepthStencilState.DepthEnable = FALSE;</span><br><span class="line">		psoDesc.DepthStencilState.StencilEnable = FALSE;</span><br><span class="line">		psoDesc.SampleMask = UINT_MAX;</span><br><span class="line">		psoDesc.PrimitiveTopologyType = D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE;</span><br><span class="line">		psoDesc.NumRenderTargets = <span class="number">1</span>;</span><br><span class="line">		psoDesc.RTVFormats[<span class="number">0</span>] = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">		psoDesc.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateGraphicsPipelineState</span>(&amp;psoDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;pipelineState)));</span><br></pre></td></tr></table></figure>

<h2 id="顶点缓存和顶点缓存视图"><a href="#顶点缓存和顶点缓存视图" class="headerlink" title="顶点缓存和顶点缓存视图"></a>顶点缓存和顶点缓存视图</h2><ul>
<li><p>咱们需要定义一个顶点结构体，这个结构体包含每个顶点的各种属性，暂时就包含位置和颜色2个属性。这里需要把DX的数学库（<code>DirectXMath.h</code>）包含一下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Vertex</span></span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT3 position;</span><br><span class="line">	XMFLOAT4 color;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后创建顶点缓存和顶点缓存视图</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Vertex triangleVertices[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; &#123; <span class="number">0.0f</span>, <span class="number">0.5f</span>, <span class="number">0.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> UINT vertexBufferSize = <span class="built_in">sizeof</span>(triangleVertices);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		CD3DX12_HEAP_PROPERTIES heapProperties = <span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD);</span><br><span class="line">		CD3DX12_RESOURCE_DESC resourceDes = CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(vertexBufferSize);</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			&amp;resourceDes,</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;vertexBuffer)));</span><br><span class="line"></span><br><span class="line">		UINT8* pVertexDataBegin;</span><br><span class="line">		<span class="function">CD3DX12_RANGE <span class="title">readRange</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>; </span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(vertexBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, &amp;readRange, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;pVertexDataBegin)));</span><br><span class="line">		<span class="built_in">memcpy</span>(pVertexDataBegin, triangleVertices, <span class="built_in">sizeof</span>(triangleVertices));</span><br><span class="line">		vertexBuffer-&gt;<span class="built_in">Unmap</span>(<span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		vertexBufferView.BufferLocation = vertexBuffer-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">		vertexBufferView.StrideInBytes = <span class="built_in">sizeof</span>(Vertex);</span><br><span class="line">		vertexBufferView.SizeInBytes = vertexBufferSize;</span><br></pre></td></tr></table></figure>

<h2 id="LoadAsset方法完整代码"><a href="#LoadAsset方法完整代码" class="headerlink" title="LoadAsset方法完整代码"></a>LoadAsset方法完整代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadAsset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	&#123;</span><br><span class="line">		CD3DX12_ROOT_SIGNATURE_DESC rootSignatureDesc;</span><br><span class="line">		rootSignatureDesc.<span class="built_in">Init</span>(<span class="number">0</span>, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>, D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT);</span><br><span class="line"></span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; signature;</span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; error;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3D12SerializeRootSignature</span>(&amp;rootSignatureDesc, D3D_ROOT_SIGNATURE_VERSION_1, &amp;signature, &amp;error));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateRootSignature</span>(<span class="number">0</span>, signature-&gt;<span class="built_in">GetBufferPointer</span>(), signature-&gt;<span class="built_in">GetBufferSize</span>(), <span class="built_in">IID_PPV_ARGS</span>(&amp;rootSignature)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; vertexShader;</span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; pixelShader;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_DEBUG)</span></span><br><span class="line">		UINT compileFlags = D3DCOMPILE_DEBUG | D3DCOMPILE_SKIP_OPTIMIZATION;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		UINT compileFlags = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DCompileFromFile</span>(std::<span class="built_in">wstring</span>(<span class="string">L&quot;Assets/shaders.hlsl&quot;</span>).<span class="built_in">c_str</span>(), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="string">&quot;VSMain&quot;</span>, <span class="string">&quot;vs_5_0&quot;</span>, compileFlags, <span class="number">0</span>, &amp;vertexShader, <span class="literal">nullptr</span>));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DCompileFromFile</span>(std::<span class="built_in">wstring</span>(<span class="string">L&quot;Assets/shaders.hlsl&quot;</span>).<span class="built_in">c_str</span>(), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="string">&quot;PSMain&quot;</span>, <span class="string">&quot;ps_5_0&quot;</span>, compileFlags, <span class="number">0</span>, &amp;pixelShader, <span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">		D3D12_INPUT_ELEMENT_DESC inputElementDescs[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">			&#123; <span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		D3D12_GRAPHICS_PIPELINE_STATE_DESC psoDesc = &#123;&#125;;</span><br><span class="line">		psoDesc.InputLayout = &#123; inputElementDescs, _countof(inputElementDescs) &#125;;</span><br><span class="line">		psoDesc.pRootSignature = rootSignature.<span class="built_in">Get</span>();</span><br><span class="line">		psoDesc.VS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(vertexShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.PS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(pixelShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.RasterizerState = <span class="built_in">CD3DX12_RASTERIZER_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.BlendState = <span class="built_in">CD3DX12_BLEND_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.DepthStencilState.DepthEnable = FALSE;</span><br><span class="line">		psoDesc.DepthStencilState.StencilEnable = FALSE;</span><br><span class="line">		psoDesc.SampleMask = UINT_MAX;</span><br><span class="line">		psoDesc.PrimitiveTopologyType = D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE;</span><br><span class="line">		psoDesc.NumRenderTargets = <span class="number">1</span>;</span><br><span class="line">		psoDesc.RTVFormats[<span class="number">0</span>] = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">		psoDesc.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateGraphicsPipelineState</span>(&amp;psoDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;pipelineState)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommandList</span>(<span class="number">0</span>, D3D12_COMMAND_LIST_TYPE_DIRECT, commandAllocator.<span class="built_in">Get</span>(), pipelineState.<span class="built_in">Get</span>(), <span class="built_in">IID_PPV_ARGS</span>(&amp;commandList)));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(commandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		Vertex triangleVertices[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; &#123; <span class="number">0.0f</span>, <span class="number">0.5f</span>, <span class="number">0.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> UINT vertexBufferSize = <span class="built_in">sizeof</span>(triangleVertices);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		CD3DX12_HEAP_PROPERTIES heapProperties = <span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD);</span><br><span class="line">		CD3DX12_RESOURCE_DESC resourceDes = CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(vertexBufferSize);</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			&amp;resourceDes,</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;vertexBuffer)));</span><br><span class="line"></span><br><span class="line">		UINT8* pVertexDataBegin;</span><br><span class="line">		<span class="function">CD3DX12_RANGE <span class="title">readRange</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>; </span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(vertexBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, &amp;readRange, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;pVertexDataBegin)));</span><br><span class="line">		<span class="built_in">memcpy</span>(pVertexDataBegin, triangleVertices, <span class="built_in">sizeof</span>(triangleVertices));</span><br><span class="line">		vertexBuffer-&gt;<span class="built_in">Unmap</span>(<span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		vertexBufferView.BufferLocation = vertexBuffer-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">		vertexBufferView.StrideInBytes = <span class="built_in">sizeof</span>(Vertex);</span><br><span class="line">		vertexBufferView.SizeInBytes = vertexBufferSize;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE, <span class="built_in">IID_PPV_ARGS</span>(&amp;fence)));</span><br><span class="line">		fenceValue = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		fenceEvent = <span class="built_in">CreateEvent</span>(<span class="literal">nullptr</span>, FALSE, FALSE, <span class="literal">nullptr</span>);</span><br><span class="line">		<span class="keyword">if</span> (fenceEvent == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ThrowIfFailed</span>(<span class="built_in">HRESULT_FROM_WIN32</span>(<span class="built_in">GetLastError</span>()));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改PopulateCommandList方法"><a href="#修改PopulateCommandList方法" class="headerlink" title="修改PopulateCommandList方法"></a>修改<code>PopulateCommandList</code>方法</h2><ul>
<li>使用<code>commandList</code>记录新的命令去绘制三角形。</li>
<li>补充两个东西，一个视口viewport，还有一个裁剪矩形scissorRect</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CD3DX12_VIEWPORT <span class="title">viewport</span><span class="params">(<span class="number">0.0f</span>,<span class="number">0.0f</span>, width,height)</span></span>;</span><br><span class="line"><span class="function">CD3DX12_RECT <span class="title">scissorRect</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, width, height)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后在<code>PopulateCommandList</code>方法里面添加几个新的命令。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PopulateCommandList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(commandAllocator-&gt;<span class="built_in">Reset</span>());</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(commandList-&gt;<span class="built_in">Reset</span>(commandAllocator.<span class="built_in">Get</span>(), pipelineState.<span class="built_in">Get</span>()));</span><br><span class="line"></span><br><span class="line">	commandList-&gt;<span class="built_in">SetGraphicsRootSignature</span>(rootSignature.<span class="built_in">Get</span>());</span><br><span class="line">	commandList-&gt;<span class="built_in">RSSetViewports</span>(<span class="number">1</span>, &amp;viewport);</span><br><span class="line">	commandList-&gt;<span class="built_in">RSSetScissorRects</span>(<span class="number">1</span>, &amp;scissorRect);</span><br><span class="line"></span><br><span class="line">	D3D12_RESOURCE_BARRIER resBarrier = CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(renderTargets[frameIndex].<span class="built_in">Get</span>(), D3D12_RESOURCE_STATE_PRESENT, D3D12_RESOURCE_STATE_RENDER_TARGET);</span><br><span class="line">	commandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;resBarrier);</span><br><span class="line"></span><br><span class="line">	<span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHandle</span><span class="params">(rtvHeap-&gt;GetCPUDescriptorHandleForHeapStart(), frameIndex, rtvDescriptorSize)</span></span>;</span><br><span class="line"></span><br><span class="line">	commandList-&gt;<span class="built_in">OMSetRenderTargets</span>(<span class="number">1</span>, &amp;rtvHandle, FALSE, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> clearColor[] = &#123; color[<span class="number">0</span>], color[<span class="number">1</span>], color[<span class="number">2</span>], <span class="number">1.0f</span> &#125;;</span><br><span class="line">	commandList-&gt;<span class="built_in">ClearRenderTargetView</span>(rtvHandle, clearColor, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">	commandList-&gt;<span class="built_in">IASetPrimitiveTopology</span>(D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST);</span><br><span class="line">	commandList-&gt;<span class="built_in">IASetVertexBuffers</span>(<span class="number">0</span>, <span class="number">1</span>, &amp;vertexBufferView);</span><br><span class="line">	commandList-&gt;<span class="built_in">DrawInstanced</span>(<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	resBarrier = CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(renderTargets[frameIndex].<span class="built_in">Get</span>(), D3D12_RESOURCE_STATE_RENDER_TARGET, D3D12_RESOURCE_STATE_PRESENT);</span><br><span class="line">	commandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;resBarrier);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(commandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230719150935918.png" alt="image-20230719150935918"></p>
<h1 id="六-绘制四边形"><a href="#六-绘制四边形" class="headerlink" title="六 绘制四边形"></a>六 绘制四边形</h1><h2 id="索引缓冲区"><a href="#索引缓冲区" class="headerlink" title="索引缓冲区"></a>索引缓冲区</h2><ul>
<li>索引缓冲区是索引列表。每个索引代表一个顶点。每 3 个索引代表一个三角形。</li>
</ul>
<h2 id="顶点数组"><a href="#顶点数组" class="headerlink" title="顶点数组"></a>顶点数组</h2><p>咱们只需要4个顶点就可以绘制一个四边形，更新以后的顶点结构体数组。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Vertex triangleVertices[] =</span><br><span class="line">&#123;</span><br><span class="line">	&#123; &#123; <span class="number">-0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="索引数组"><a href="#索引数组" class="headerlink" title="索引数组"></a>索引数组</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DWORD triangleIndexs[]</span><br><span class="line">&#123;</span><br><span class="line">	<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,</span><br><span class="line">	<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="顶点缓存和索引缓存"><a href="#顶点缓存和索引缓存" class="headerlink" title="顶点缓存和索引缓存"></a>顶点缓存和索引缓存</h2><p>见代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		<span class="comment">/*三角形</span></span><br><span class="line"><span class="comment">		Vertex triangleVertices[] =</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			&#123; &#123; 0.0f, 0.5f, 0.0f &#125;, &#123; 1.0f, 0.0f, 0.0f, 1.0f &#125; &#125;,</span></span><br><span class="line"><span class="comment">			&#123; &#123; 0.5f, -0.5f, 0.0f &#125;, &#123; 0.0f, 1.0f, 0.0f, 1.0f &#125; &#125;,</span></span><br><span class="line"><span class="comment">			&#123; &#123; -0.5f, -0.5f, 0.0f &#125;, &#123; 0.0f, 0.0f, 1.0f, 1.0f &#125; &#125;</span></span><br><span class="line"><span class="comment">		&#125;;</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="comment">//顶点数组</span></span><br><span class="line">		Vertex triangleVertices[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; &#123; <span class="number">-0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//索引数组</span></span><br><span class="line">		DWORD triangleIndexs[]</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,</span><br><span class="line">			<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> UINT vertexBufferSize = <span class="built_in">sizeof</span>(triangleVertices);</span><br><span class="line">		<span class="type">const</span> UINT indexBufferSize = <span class="built_in">sizeof</span>(triangleIndexs);<span class="comment">//新增：索引缓冲</span></span><br><span class="line"></span><br><span class="line">		CD3DX12_HEAP_PROPERTIES heapProperties = <span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD);</span><br><span class="line">		CD3DX12_RESOURCE_DESC resourceDes = CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(vertexBufferSize);<span class="comment">//统一资源</span></span><br><span class="line">		<span class="comment">//CD3DX12_RESOURCE_DESC indexResourceDes = CD3DX12_RESOURCE_DESC::Buffer(indexBufferSize);//索引缓冲资源</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			&amp;resourceDes,</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;vertexBuffer)));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//新增：创建提交的资源</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			<span class="comment">//&amp;indexResourceDes,</span></span><br><span class="line">			&amp;resourceDes,</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;indexBuffer)));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//UINT8* pVertexDataBegin;</span></span><br><span class="line">		UINT8* pDataBegin;<span class="comment">//修改:pVertexDatabegin</span></span><br><span class="line">		<span class="function">CD3DX12_RANGE <span class="title">readRange</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//ThrowIfFailed(vertexBuffer-&gt;Map(0, &amp;readRange, reinterpret_cast&lt;void**&gt;(&amp;pVertexDataBegin)));</span></span><br><span class="line">		<span class="comment">//memcpy(pVertexDataBegin, triangleVertices, sizeof(triangleVertices));</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(vertexBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, &amp;readRange, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;pDataBegin)));</span><br><span class="line">		<span class="built_in">memcpy</span>(pDataBegin, triangleVertices, <span class="built_in">sizeof</span>(triangleVertices));<span class="comment">//修改：pDataBegin</span></span><br><span class="line">		vertexBuffer-&gt;<span class="built_in">Unmap</span>(<span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//新增：索引缓存</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(indexBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, &amp;readRange, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;pDataBegin)));</span><br><span class="line">		<span class="built_in">memcpy</span>(pDataBegin, triangleIndexs, <span class="built_in">sizeof</span>(triangleIndexs));</span><br><span class="line">		indexBuffer-&gt;<span class="built_in">Unmap</span>(<span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		vertexBufferView.BufferLocation = vertexBuffer-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">		vertexBufferView.StrideInBytes = <span class="built_in">sizeof</span>(Vertex);</span><br><span class="line">		vertexBufferView.SizeInBytes = vertexBufferSize;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//新增：索引缓存</span></span><br><span class="line">		indexBufferView.BufferLocation = indexBuffer-&gt;<span class="built_in">GetGPUVirtualAddress</span>();<span class="comment">//获得GPU虚拟地址</span></span><br><span class="line">		indexBufferView.Format = DXGI_FORMAT_R32_UINT;<span class="comment">//</span></span><br><span class="line">		indexBufferView.SizeInBytes = indexBufferSize;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h1 id="七-深度测试"><a href="#七-深度测试" class="headerlink" title="七 深度测试"></a>七 深度测试</h1><p>上次的基础上绘制两个四边形那就很简单了，直接在顶点数组里面加点数据就可以了。</p>
<ul>
<li>z轴越小，离摄像机越近</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Vertex triangleVertices[] =</span><br><span class="line">&#123;</span><br><span class="line">                      <span class="comment">//第一个绿色四边形</span></span><br><span class="line">	&#123; &#123; <span class="number">-0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">                      <span class="comment">//第二个蓝色四边形</span></span><br><span class="line">	&#123; &#123; <span class="number">-0.75f</span>, <span class="number">0.75f</span>, <span class="number">0.7f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.7f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">-0.75f</span>, <span class="number">0.0f</span>, <span class="number">0.7f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">	&#123; &#123; <span class="number">0.0f</span>, <span class="number">0.75f</span>, <span class="number">0.7f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="绘制第二个四边形命令"><a href="#绘制第二个四边形命令" class="headerlink" title="绘制第二个四边形命令"></a>绘制第二个四边形命令</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(<span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="number">0</span>);<span class="comment">//第一个绿色四边形</span></span><br><span class="line">	commandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(<span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);<span class="comment">//第二个蓝色四边形</span></span><br></pre></td></tr></table></figure>

<h3 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h3><p>蓝色却依旧覆盖了绿色，这是因为先绘制了绿色的四边形，然后绘制的蓝色四边形，把绿色覆盖了</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230719202449145.png" alt="image-20230719202449145"></p>
<h2 id="深度测试"><a href="#深度测试" class="headerlink" title="深度测试"></a>深度测试</h2><h3 id="深度模板堆"><a href="#深度模板堆" class="headerlink" title="深度模板堆"></a>深度模板堆</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D3D12_DESCRIPTOR_HEAP_DESC dsvHeapDesc = &#123;&#125;;</span><br><span class="line">		dsvHeapDesc.NumDescriptors = <span class="number">1</span>;</span><br><span class="line">		dsvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_DSV;</span><br><span class="line">		dsvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;dsvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;dsvHeap)));</span><br></pre></td></tr></table></figure>

<h3 id="修改管线状态对象，启用深度模板"><a href="#修改管线状态对象，启用深度模板" class="headerlink" title="修改管线状态对象，启用深度模板"></a>修改管线状态对象，启用深度模板</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">D3D12_GRAPHICS_PIPELINE_STATE_DESC psoDesc = &#123;&#125;;</span><br><span class="line">		psoDesc.InputLayout = &#123; inputElementDescs, _countof(inputElementDescs) &#125;;</span><br><span class="line">		psoDesc.pRootSignature = rootSignature.<span class="built_in">Get</span>();</span><br><span class="line">		psoDesc.VS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(vertexShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.PS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(pixelShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.RasterizerState = <span class="built_in">CD3DX12_RASTERIZER_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.BlendState = <span class="built_in">CD3DX12_BLEND_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.DepthStencilState = <span class="built_in">CD3DX12_DEPTH_STENCIL_DESC</span>(D3D12_DEFAULT);<span class="comment">//深度模板状态</span></span><br><span class="line">		psoDesc.SampleMask = UINT_MAX;</span><br><span class="line">		psoDesc.PrimitiveTopologyType = D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE;</span><br><span class="line">		psoDesc.NumRenderTargets = <span class="number">1</span>;</span><br><span class="line">		psoDesc.RTVFormats[<span class="number">0</span>] = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">		psoDesc.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateGraphicsPipelineState</span>(&amp;psoDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;pipelineState)));</span><br></pre></td></tr></table></figure>

<h3 id="深度缓存"><a href="#深度缓存" class="headerlink" title="深度缓存"></a>深度缓存</h3><p>创建深度模板缓存，这里得采用默认堆类型。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">D3D12_DEPTH_STENCIL_VIEW_DESC depthStencilDesc = &#123;&#125;;</span><br><span class="line">		depthStencilDesc.Format = DXGI_FORMAT_D32_FLOAT;</span><br><span class="line">		depthStencilDesc.ViewDimension = D3D12_DSV_DIMENSION_TEXTURE2D;</span><br><span class="line">		depthStencilDesc.Flags = D3D12_DSV_FLAG_NONE;</span><br><span class="line"></span><br><span class="line">		D3D12_CLEAR_VALUE depthOptimizedClearValue = &#123;&#125;;</span><br><span class="line">		depthOptimizedClearValue.Format = DXGI_FORMAT_D32_FLOAT;</span><br><span class="line">		depthOptimizedClearValue.DepthStencil.Depth = <span class="number">1.0f</span>;</span><br><span class="line">		depthOptimizedClearValue.DepthStencil.Stencil = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		CD3DX12_HEAP_PROPERTIES heapProperties2 = <span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT);</span><br><span class="line">		CD3DX12_RESOURCE_DESC tex2D = CD3DX12_RESOURCE_DESC::<span class="built_in">Tex2D</span>(DXGI_FORMAT_D32_FLOAT, width, height, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties2,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			&amp;tex2D,</span><br><span class="line">			D3D12_RESOURCE_STATE_DEPTH_WRITE,</span><br><span class="line">			&amp;depthOptimizedClearValue,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;depthStencilBuffer)));</span><br><span class="line"></span><br><span class="line">		device-&gt;<span class="built_in">CreateDepthStencilView</span>(depthStencilBuffer.<span class="built_in">Get</span>(), &amp;depthStencilDesc, dsvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>());</span><br></pre></td></tr></table></figure>

<h3 id="添加命令"><a href="#添加命令" class="headerlink" title="添加命令"></a>添加命令</h3><p>然后在准备渲染之前得清除深度模板视图和清除渲染目标视图一样。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHandle</span><span class="params">(rtvHeap-&gt;GetCPUDescriptorHandleForHeapStart(), frameIndex, rtvDescriptorSize)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">dsvHandle</span><span class="params">(dsvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line"></span><br><span class="line">	commandList-&gt;<span class="built_in">OMSetRenderTargets</span>(<span class="number">1</span>, &amp;rtvHandle, FALSE, &amp;dsvHandle);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> clearColor[] = &#123; color[<span class="number">0</span>], color[<span class="number">1</span>], color[<span class="number">2</span>], <span class="number">1.0f</span> &#125;;</span><br><span class="line">	commandList-&gt;<span class="built_in">ClearRenderTargetView</span>(rtvHandle, clearColor, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">	commandList-&gt;<span class="built_in">ClearDepthStencilView</span>(dsvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>(), D3D12_CLEAR_FLAG_DEPTH, <span class="number">1.0f</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230719211144048.png" alt="image-20230719211144048"></p>
<h1 id="八-常量缓存"><a href="#八-常量缓存" class="headerlink" title="八 常量缓存"></a>八 常量缓存</h1><h2 id="常量缓存区结构体"><a href="#常量缓存区结构体" class="headerlink" title="常量缓存区结构体"></a>常量缓存区结构体</h2><p>定义咱们需要传递给着色器的结构体，这个结构体大小必须是256字节对齐</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SceneConstantBuffer</span></span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT4 offset;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加一个256字节对齐的方法</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> UINT <span class="title">CalcConstantBufferByteSize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Constant buffers must be a multiple of the minimum hardware</span></span><br><span class="line">	<span class="comment">// allocation size (usually 256 bytes).  So round up to nearest</span></span><br><span class="line">	<span class="comment">// multiple of 256.  We do this by adding 255 and then masking off</span></span><br><span class="line">	<span class="comment">// the lower 2 bytes which store all bits &lt; 256.</span></span><br><span class="line">	<span class="comment">// Example: Suppose byteSize = 300.</span></span><br><span class="line">	<span class="comment">// (300 + 255) &amp; ~255</span></span><br><span class="line">	<span class="comment">// 555 &amp; ~255</span></span><br><span class="line">	<span class="comment">// 0x022B &amp; ~0x00ff</span></span><br><span class="line">	<span class="comment">// 0x022B &amp; 0xff00</span></span><br><span class="line">	<span class="comment">// 0x0200</span></span><br><span class="line">	<span class="comment">// 512</span></span><br><span class="line">	UINT byteSize = <span class="built_in">sizeof</span>(T);</span><br><span class="line">	<span class="keyword">return</span> (byteSize + <span class="number">255</span>) &amp; ~<span class="number">255</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="常量缓存堆"><a href="#常量缓存堆" class="headerlink" title="常量缓存堆"></a>常量缓存堆</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D3D12_DESCRIPTOR_HEAP_DESC cbvHeapDesc = &#123;&#125;;</span><br><span class="line">		cbvHeapDesc.NumDescriptors = <span class="number">1</span>;</span><br><span class="line">		cbvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV;</span><br><span class="line">		cbvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_SHADER_VISIBLE;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;cbvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;cbvHeap)));</span><br></pre></td></tr></table></figure>

<h3 id="常量缓存"><a href="#常量缓存" class="headerlink" title="常量缓存"></a>常量缓存</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> UINT constantBufferSize = <span class="built_in">CalcConstantBufferByteSize</span>&lt;SceneConstantBuffer&gt;();</span><br><span class="line">		CD3DX12_RESOURCE_DESC constantResourceDes = CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(constantBufferSize);</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			&amp;constantResourceDes,</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;constantBuffer)));</span><br><span class="line"></span><br><span class="line">		D3D12_CONSTANT_BUFFER_VIEW_DESC cbvDesc = &#123;&#125;;</span><br><span class="line">		cbvDesc.BufferLocation = constantBuffer-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">		cbvDesc.SizeInBytes = constantBufferSize;</span><br><span class="line">		device-&gt;<span class="built_in">CreateConstantBufferView</span>(&amp;cbvDesc, cbvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>());</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(constantBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, &amp;readRange, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;pCbvDataBegin)));</span><br><span class="line">		<span class="built_in">memcpy</span>(pCbvDataBegin, &amp;constantBufferData, <span class="built_in">sizeof</span>(constantBufferData));</span><br></pre></td></tr></table></figure>

<h2 id="根签名"><a href="#根签名" class="headerlink" title="根签名"></a>根签名</h2><p>根签名由根参数组成，根参数可以是根常量、根描述符和描述符表，在这里创建一个描述符表，存放了咱们的常量缓存视图。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">D3D12_FEATURE_DATA_ROOT_SIGNATURE featureData = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">		featureData.HighestVersion = D3D_ROOT_SIGNATURE_VERSION_1_1;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(device-&gt;<span class="built_in">CheckFeatureSupport</span>(D3D12_FEATURE_ROOT_SIGNATURE, &amp;featureData, <span class="built_in">sizeof</span>(featureData))))</span><br><span class="line">		&#123;</span><br><span class="line">			featureData.HighestVersion = D3D_ROOT_SIGNATURE_VERSION_1_0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CD3DX12_DESCRIPTOR_RANGE1 ranges[<span class="number">1</span>];</span><br><span class="line">		CD3DX12_ROOT_PARAMETER1 rootParameters[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">		ranges[<span class="number">0</span>].<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_CBV, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, D3D12_DESCRIPTOR_RANGE_FLAG_DATA_STATIC);</span><br><span class="line">		rootParameters[<span class="number">0</span>].<span class="built_in">InitAsDescriptorTable</span>(<span class="number">1</span>, &amp;ranges[<span class="number">0</span>], D3D12_SHADER_VISIBILITY_VERTEX);</span><br><span class="line"></span><br><span class="line">		D3D12_ROOT_SIGNATURE_FLAGS rootSignatureFlags =</span><br><span class="line">			D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT |</span><br><span class="line">			D3D12_ROOT_SIGNATURE_FLAG_DENY_HULL_SHADER_ROOT_ACCESS |</span><br><span class="line">			D3D12_ROOT_SIGNATURE_FLAG_DENY_DOMAIN_SHADER_ROOT_ACCESS |</span><br><span class="line">			D3D12_ROOT_SIGNATURE_FLAG_DENY_GEOMETRY_SHADER_ROOT_ACCESS |</span><br><span class="line">			D3D12_ROOT_SIGNATURE_FLAG_DENY_PIXEL_SHADER_ROOT_ACCESS;</span><br><span class="line"></span><br><span class="line">		CD3DX12_VERSIONED_ROOT_SIGNATURE_DESC rootSignatureDesc;</span><br><span class="line">		rootSignatureDesc.<span class="built_in">Init_1_1</span>(_countof(rootParameters), rootParameters, <span class="number">0</span>, <span class="literal">nullptr</span>, rootSignatureFlags);</span><br><span class="line"></span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; signature;</span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; error;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DX12SerializeVersionedRootSignature</span>(&amp;rootSignatureDesc, featureData.HighestVersion, &amp;signature, &amp;error));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateRootSignature</span>(<span class="number">0</span>, signature-&gt;<span class="built_in">GetBufferPointer</span>(), signature-&gt;<span class="built_in">GetBufferSize</span>(), <span class="built_in">IID_PPV_ARGS</span>(&amp;rootSignature)));</span><br></pre></td></tr></table></figure>

<h2 id="命令列表"><a href="#命令列表" class="headerlink" title="命令列表"></a>命令列表</h2><p>添加一些代码去设置咱们的常量缓存堆。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ID3D12DescriptorHeap* ppHeaps[] = &#123; cbvHeap.<span class="built_in">Get</span>() &#125;;</span><br><span class="line">	commandList-&gt;<span class="built_in">SetDescriptorHeaps</span>(_countof(ppHeaps), ppHeaps);</span><br><span class="line"></span><br><span class="line">	commandList-&gt;<span class="built_in">SetGraphicsRootDescriptorTable</span>(<span class="number">0</span>, cbvHeap-&gt;<span class="built_in">GetGPUDescriptorHandleForHeapStart</span>());</span><br></pre></td></tr></table></figure>

<h2 id="OnUpdate方法"><a href="#OnUpdate方法" class="headerlink" title="OnUpdate方法"></a>OnUpdate方法</h2><p>在OnUpdate方法里面对常量缓存里面的数据进行更新</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">float</span> translationSpeed = <span class="number">0.005f</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">float</span> offsetBounds = <span class="number">1.25f</span>;</span><br><span class="line"></span><br><span class="line">constantBufferData.offset.x += translationSpeed;</span><br><span class="line"><span class="keyword">if</span> (constantBufferData.offset.x &gt; offsetBounds)</span><br><span class="line">&#123;</span><br><span class="line">	constantBufferData.offset.x = -offsetBounds;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(pCbvDataBegin, &amp;constantBufferData, <span class="built_in">sizeof</span>(constantBufferData));</span><br></pre></td></tr></table></figure>

<h2 id="shaders-hlsl-1"><a href="#shaders-hlsl-1" class="headerlink" title="shaders.hlsl"></a><code>shaders.hlsl</code></h2><p>在着色器代码里面添加相应的结构体，拿来接收咱们传递过来的数据，如何加到咱们的顶点位置上面去，这样咱们的四边形就能动起来了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cbuffer SceneConstantBuffer : <span class="built_in">register</span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4 offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PSInput</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float4 color : COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PSInput <span class="title">VSMain</span><span class="params">(float4 position : POSITION, float4 color : COLOR)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSInput result;</span><br><span class="line"></span><br><span class="line">        result.position = position + offset;</span><br><span class="line">    result.color = color;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PSMain</span><span class="params">(PSInput input)</span> : SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> input.color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解决一个bug"><a href="#解决一个bug" class="headerlink" title="解决一个bug"></a>解决一个bug</h2><ul>
<li>运行时一直在输出信息</li>
</ul>
<p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230720142427250.png" alt="image-20230720142427250"></p>
<p>创建管线状态对象描述时加上下面最后一句就可以了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">D3D12_GRAPHICS_PIPELINE_STATE_DESC psoDesc = &#123;&#125;;</span><br><span class="line">		psoDesc.InputLayout = &#123; inputElementDescs, _countof(inputElementDescs) &#125;;</span><br><span class="line">		psoDesc.pRootSignature = rootSignature.<span class="built_in">Get</span>();</span><br><span class="line">		psoDesc.VS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(vertexShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.PS = <span class="built_in">CD3DX12_SHADER_BYTECODE</span>(pixelShader.<span class="built_in">Get</span>());</span><br><span class="line">		psoDesc.RasterizerState = <span class="built_in">CD3DX12_RASTERIZER_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.BlendState = <span class="built_in">CD3DX12_BLEND_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.DepthStencilState = <span class="built_in">CD3DX12_DEPTH_STENCIL_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">		psoDesc.SampleMask = UINT_MAX;</span><br><span class="line">		psoDesc.PrimitiveTopologyType = D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE;</span><br><span class="line">		psoDesc.NumRenderTargets = <span class="number">1</span>;</span><br><span class="line">		psoDesc.RTVFormats[<span class="number">0</span>] = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">		psoDesc.SampleDesc.Count = <span class="number">1</span>;</span><br><span class="line">		psoDesc.DSVFormat = DXGI_FORMAT_D32_FLOAT;<span class="comment">//加上这玩意</span></span><br></pre></td></tr></table></figure>

<h1 id="九-绘制彩色立方体"><a href="#九-绘制彩色立方体" class="headerlink" title="九 绘制彩色立方体"></a>九 绘制彩色立方体</h1><h2 id="顶点数组-1"><a href="#顶点数组-1" class="headerlink" title="顶点数组"></a>顶点数组</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vertex triangleVertices[] =</span><br><span class="line">	&#123;</span><br><span class="line">		&#123; &#123; <span class="number">-1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; <span class="number">-1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; +<span class="number">1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; +<span class="number">1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; <span class="number">-1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; <span class="number">-1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; +<span class="number">1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">		&#123; &#123; +<span class="number">1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="索引数组-1"><a href="#索引数组-1" class="headerlink" title="索引数组"></a>索引数组</h2><p>一个立方体就六个面，也就是12个三角形，也就是36个索引了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DWORD triangleIndexs[]</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// front face</span></span><br><span class="line">			<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>,</span><br><span class="line">			<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// back face</span></span><br><span class="line">			<span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>,</span><br><span class="line">			<span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// left face</span></span><br><span class="line">			<span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>,</span><br><span class="line">			<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// right face</span></span><br><span class="line">			<span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>,</span><br><span class="line">			<span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// top face</span></span><br><span class="line">			<span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,</span><br><span class="line">			<span class="number">1</span>, <span class="number">6</span>, <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// bottom face</span></span><br><span class="line">			<span class="number">4</span>, <span class="number">0</span>, <span class="number">3</span>,</span><br><span class="line">			<span class="number">4</span>, <span class="number">3</span>, <span class="number">7</span></span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="常量缓存-1"><a href="#常量缓存-1" class="headerlink" title="常量缓存"></a>常量缓存</h2><p>咱们需要修改一下常量缓存，把上次的offset换成MVP矩阵</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SceneConstantBuffer</span></span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT4X4 MVP;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="OnUpdate"><a href="#OnUpdate" class="headerlink" title="OnUpdate"></a>OnUpdate</h2><p>咱们就在更新函数里面构造MVP矩阵，你可以在这里面不断更新数据，让摄像机动起来。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">XMVECTOR pos = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">5.0f</span>, <span class="number">-5.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">	XMVECTOR target = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">	XMVECTOR up = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	XMMATRIX v = <span class="built_in">XMMatrixLookAtLH</span>(pos, target, up);</span><br><span class="line"></span><br><span class="line">	XMMATRIX m = <span class="built_in">XMMatrixIdentity</span>();</span><br><span class="line">	XMMATRIX p = <span class="built_in">XMMatrixPerspectiveFovLH</span>(XM_PIDIV4,width/height,<span class="number">1.0f</span>,<span class="number">1000.0f</span>);</span><br><span class="line">	XMMATRIX MVP = m * v * p;</span><br><span class="line"></span><br><span class="line">	SceneConstantBuffer objConstants;</span><br><span class="line">	<span class="built_in">XMStoreFloat4x4</span>(&amp;objConstants.MVP, <span class="built_in">XMMatrixTranspose</span>(MVP));</span><br><span class="line">	<span class="built_in">memcpy</span>(pCbvDataBegin, &amp;objConstants, <span class="built_in">sizeof</span>(objConstants));</span><br></pre></td></tr></table></figure>

<h2 id="命令列表-1"><a href="#命令列表-1" class="headerlink" title="命令列表"></a>命令列表</h2><p>修改一下咱们的绘制调用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(<span class="number">36</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h2 id="着色器"><a href="#着色器" class="headerlink" title="着色器"></a>着色器</h2><p>修改一下着色器，在顶点着色器里面，咱们给每一个顶点的位置都乘以MVP矩阵。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cbuffer SceneConstantBuffer : <span class="built_in">register</span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 WorldViewProj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PSInput</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float4 color : COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PSInput <span class="title">VSMain</span><span class="params">(float4 position : POSITION, float4 color : COLOR)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSInput result;</span><br><span class="line"></span><br><span class="line">    result.position = <span class="built_in">mul</span>(position,WorldViewProj);</span><br><span class="line">    result.color = color;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PSMain</span><span class="params">(PSInput input)</span> : SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> input.color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十-纹理"><a href="#十-纹理" class="headerlink" title="十 纹理"></a>十 纹理</h1><p>加载纹理的方式有很多种，咱们采用<strong>Windows Imaging Component (WIC)。</strong></p>
<h2 id="加载纹理方法"><a href="#加载纹理方法" class="headerlink" title="加载纹理方法"></a>加载纹理方法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DXGI_FORMAT <span class="title">GetDXGIFormatFromWICFormat</span><span class="params">(WICPixelFormatGUID&amp; wicFormatGUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat128bppRGBAFloat) <span class="keyword">return</span> DXGI_FORMAT_R32G32B32A32_FLOAT;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppRGBAHalf) <span class="keyword">return</span> DXGI_FORMAT_R16G16B16A16_FLOAT;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppRGBA) <span class="keyword">return</span> DXGI_FORMAT_R16G16B16A16_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppRGBA) <span class="keyword">return</span> DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppBGRA) <span class="keyword">return</span> DXGI_FORMAT_B8G8R8A8_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppBGR) <span class="keyword">return</span> DXGI_FORMAT_B8G8R8X8_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppRGBA1010102XR) <span class="keyword">return</span> DXGI_FORMAT_R10G10B10_XR_BIAS_A2_UNORM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppRGBA1010102) <span class="keyword">return</span> DXGI_FORMAT_R10G10B10A2_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat16bppBGRA5551) <span class="keyword">return</span> DXGI_FORMAT_B5G5R5A1_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat16bppBGR565) <span class="keyword">return</span> DXGI_FORMAT_B5G6R5_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppGrayFloat) <span class="keyword">return</span> DXGI_FORMAT_R32_FLOAT;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat16bppGrayHalf) <span class="keyword">return</span> DXGI_FORMAT_R16_FLOAT;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat16bppGray) <span class="keyword">return</span> DXGI_FORMAT_R16_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat8bppGray) <span class="keyword">return</span> DXGI_FORMAT_R8_UNORM;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat8bppAlpha) <span class="keyword">return</span> DXGI_FORMAT_A8_UNORM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> DXGI_FORMAT_UNKNOWN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">WICPixelFormatGUID <span class="title">GetConvertToWICFormat</span><span class="params">(WICPixelFormatGUID&amp; wicFormatGUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormatBlackWhite) <span class="keyword">return</span> GUID_WICPixelFormat8bppGray;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat1bppIndexed) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat2bppIndexed) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat4bppIndexed) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat8bppIndexed) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat2bppGray) <span class="keyword">return</span> GUID_WICPixelFormat8bppGray;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat4bppGray) <span class="keyword">return</span> GUID_WICPixelFormat8bppGray;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat16bppGrayFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat16bppGrayHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppGrayFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat32bppGrayFloat;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat16bppBGR555) <span class="keyword">return</span> GUID_WICPixelFormat16bppBGRA5551;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppBGR101010) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA1010102;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat24bppBGR) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat24bppRGB) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppPBGRA) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppPRGBA) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat48bppRGB) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat48bppBGR) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppBGRA) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppPRGBA) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppPBGRA) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat48bppRGBFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat48bppBGRFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppRGBAFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppBGRAFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppRGBFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppRGBHalf) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat48bppRGBHalf) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat128bppPRGBAFloat) <span class="keyword">return</span> GUID_WICPixelFormat128bppRGBAFloat;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat128bppRGBFloat) <span class="keyword">return</span> GUID_WICPixelFormat128bppRGBAFloat;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat128bppRGBAFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat128bppRGBAFloat;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat128bppRGBFixedPoint) <span class="keyword">return</span> GUID_WICPixelFormat128bppRGBAFloat;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppRGBE) <span class="keyword">return</span> GUID_WICPixelFormat128bppRGBAFloat;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppCMYK) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppCMYK) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat40bppCMYKAlpha) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat80bppCMYKAlpha) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (_WIN32_WINNT &gt;= _WIN32_WINNT_WIN8) || defined(_WIN7_PLATFORM_UPDATE)</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat32bppRGB) <span class="keyword">return</span> GUID_WICPixelFormat32bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppRGB) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBA;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wicFormatGUID == GUID_WICPixelFormat64bppPRGBAHalf) <span class="keyword">return</span> GUID_WICPixelFormat64bppRGBAHalf;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> GUID_WICPixelFormatDontCare;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetDXGIFormatBitsPerPixel</span><span class="params">(DXGI_FORMAT&amp; dxgiFormat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R32G32B32A32_FLOAT) <span class="keyword">return</span> <span class="number">128</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R16G16B16A16_FLOAT) <span class="keyword">return</span> <span class="number">64</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R16G16B16A16_UNORM) <span class="keyword">return</span> <span class="number">64</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R8G8B8A8_UNORM) <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_B8G8R8A8_UNORM) <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_B8G8R8X8_UNORM) <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R10G10B10_XR_BIAS_A2_UNORM) <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R10G10B10A2_UNORM) <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_B5G5R5A1_UNORM) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_B5G6R5_UNORM) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R32_FLOAT) <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R16_FLOAT) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R16_UNORM) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_R8_UNORM) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_A8_UNORM) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">LoadImageDataFromFile</span><span class="params">(BYTE** imageData, D3D12_RESOURCE_DESC&amp; resourceDescription, LPCWSTR filename, <span class="type">int</span>&amp; bytesPerRow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HRESULT hr;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> IWICImagingFactory* wicFactory;</span><br><span class="line"></span><br><span class="line">	IWICBitmapDecoder* wicDecoder = <span class="literal">NULL</span>;</span><br><span class="line">	IWICBitmapFrameDecode* wicFrame = <span class="literal">NULL</span>;</span><br><span class="line">	IWICFormatConverter* wicConverter = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> imageConverted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (wicFactory == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CoInitialize</span>(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">		hr = <span class="built_in">CoCreateInstance</span>(</span><br><span class="line">			CLSID_WICImagingFactory,</span><br><span class="line">			<span class="literal">NULL</span>,</span><br><span class="line">			CLSCTX_INPROC_SERVER,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;wicFactory)</span><br><span class="line">		);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		hr = wicFactory-&gt;<span class="built_in">CreateFormatConverter</span>(&amp;wicConverter);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hr = wicFactory-&gt;<span class="built_in">CreateDecoderFromFilename</span>(</span><br><span class="line">		filename,                        </span><br><span class="line">		<span class="literal">NULL</span>,                            </span><br><span class="line">		GENERIC_READ,                    </span><br><span class="line">		WICDecodeMetadataCacheOnLoad,    </span><br><span class="line">		&amp;wicDecoder                      </span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	hr = wicDecoder-&gt;<span class="built_in">GetFrame</span>(<span class="number">0</span>, &amp;wicFrame);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	WICPixelFormatGUID pixelFormat;</span><br><span class="line">	hr = wicFrame-&gt;<span class="built_in">GetPixelFormat</span>(&amp;pixelFormat);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	UINT textureWidth, textureHeight;</span><br><span class="line">	hr = wicFrame-&gt;<span class="built_in">GetSize</span>(&amp;textureWidth, &amp;textureHeight);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	DXGI_FORMAT dxgiFormat = <span class="built_in">GetDXGIFormatFromWICFormat</span>(pixelFormat);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dxgiFormat == DXGI_FORMAT_UNKNOWN)</span><br><span class="line">	&#123;</span><br><span class="line">		WICPixelFormatGUID convertToPixelFormat = <span class="built_in">GetConvertToWICFormat</span>(pixelFormat);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (convertToPixelFormat == GUID_WICPixelFormatDontCare) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		dxgiFormat = <span class="built_in">GetDXGIFormatFromWICFormat</span>(convertToPixelFormat);</span><br><span class="line"></span><br><span class="line">		BOOL canConvert = FALSE;</span><br><span class="line">		hr = wicConverter-&gt;<span class="built_in">CanConvert</span>(pixelFormat, convertToPixelFormat, &amp;canConvert);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr) || !canConvert) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		hr = wicConverter-&gt;<span class="built_in">Initialize</span>(wicFrame, convertToPixelFormat, WICBitmapDitherTypeErrorDiffusion, <span class="number">0</span>, <span class="number">0</span>, WICBitmapPaletteTypeCustom);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		imageConverted = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> bitsPerPixel = <span class="built_in">GetDXGIFormatBitsPerPixel</span>(dxgiFormat);</span><br><span class="line">	bytesPerRow = (textureWidth * bitsPerPixel) / <span class="number">8</span>; </span><br><span class="line">	<span class="type">int</span> imageSize = bytesPerRow * textureHeight; </span><br><span class="line"></span><br><span class="line">	*imageData = (BYTE*)<span class="built_in">malloc</span>(imageSize);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (imageConverted)</span><br><span class="line">	&#123;</span><br><span class="line">		hr = wicConverter-&gt;<span class="built_in">CopyPixels</span>(<span class="number">0</span>, bytesPerRow, imageSize, *imageData);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		hr = wicFrame-&gt;<span class="built_in">CopyPixels</span>(<span class="number">0</span>, bytesPerRow, imageSize, *imageData);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resourceDescription = &#123;&#125;;</span><br><span class="line">	resourceDescription.Dimension = D3D12_RESOURCE_DIMENSION_TEXTURE2D;</span><br><span class="line">	resourceDescription.Alignment = <span class="number">0</span>;</span><br><span class="line">	resourceDescription.Width = textureWidth; </span><br><span class="line">	resourceDescription.Height = textureHeight;</span><br><span class="line">	resourceDescription.DepthOrArraySize = <span class="number">1</span>; </span><br><span class="line">	resourceDescription.MipLevels = <span class="number">1</span>; </span><br><span class="line">	resourceDescription.Format = dxgiFormat; </span><br><span class="line">	resourceDescription.SampleDesc.Count = <span class="number">1</span>; </span><br><span class="line">	resourceDescription.SampleDesc.Quality = <span class="number">0</span>; </span><br><span class="line">	resourceDescription.Layout = D3D12_TEXTURE_LAYOUT_UNKNOWN; </span><br><span class="line">	resourceDescription.Flags = D3D12_RESOURCE_FLAG_NONE; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> imageSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建描述符堆"><a href="#创建描述符堆" class="headerlink" title="创建描述符堆"></a>创建描述符堆</h2><p>首先创建堆来存放咱们的常量缓冲视图和着色器资源视图。	</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D3D12_DESCRIPTOR_HEAP_DESC cbvsrvHeapDesc = &#123;&#125;;</span><br><span class="line">		cbvsrvHeapDesc.NumDescriptors = <span class="number">2</span>;</span><br><span class="line">		cbvsrvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV;</span><br><span class="line">		cbvsrvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_SHADER_VISIBLE;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;cbvsrvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;cbvsrvHeap)));</span><br><span class="line">		cbvsrvDescriptorSize = device-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV);</span><br></pre></td></tr></table></figure>

<h2 id="根签名-1"><a href="#根签名-1" class="headerlink" title="根签名"></a>根签名</h2><h3 id="根参数"><a href="#根参数" class="headerlink" title="根参数"></a>根参数</h3><p>创建一个描述符表存放常量缓冲视图和着色器资源视图，然后放入根参数索引为0的位置。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">D3D12_FEATURE_DATA_ROOT_SIGNATURE featureData = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">		featureData.HighestVersion = D3D_ROOT_SIGNATURE_VERSION_1_1;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FAILED</span>(device-&gt;<span class="built_in">CheckFeatureSupport</span>(D3D12_FEATURE_ROOT_SIGNATURE, &amp;featureData, <span class="built_in">sizeof</span>(featureData))))</span><br><span class="line">		&#123;</span><br><span class="line">			featureData.HighestVersion = D3D_ROOT_SIGNATURE_VERSION_1_0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CD3DX12_DESCRIPTOR_RANGE1 ranges[<span class="number">2</span>];</span><br><span class="line">		CD3DX12_ROOT_PARAMETER1 rootParameters[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">		ranges[<span class="number">0</span>].<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_CBV, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, D3D12_DESCRIPTOR_RANGE_FLAG_DATA_STATIC);</span><br><span class="line">		ranges[<span class="number">1</span>].<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_SRV, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, D3D12_DESCRIPTOR_RANGE_FLAG_DATA_STATIC);</span><br><span class="line"></span><br><span class="line">		rootParameters[<span class="number">0</span>].<span class="built_in">InitAsDescriptorTable</span>(<span class="number">2</span>, &amp;ranges[<span class="number">0</span>], D3D12_SHADER_VISIBILITY_ALL);</span><br></pre></td></tr></table></figure>

<h3 id="静态采样"><a href="#静态采样" class="headerlink" title="静态采样"></a>静态采样</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">D3D12_STATIC_SAMPLER_DESC sampler = &#123;&#125;;</span><br><span class="line">		sampler.Filter = D3D12_FILTER_MIN_MAG_MIP_POINT;</span><br><span class="line">		sampler.AddressU = D3D12_TEXTURE_ADDRESS_MODE_BORDER;</span><br><span class="line">		sampler.AddressV = D3D12_TEXTURE_ADDRESS_MODE_BORDER;</span><br><span class="line">		sampler.AddressW = D3D12_TEXTURE_ADDRESS_MODE_BORDER;</span><br><span class="line">		sampler.MipLODBias = <span class="number">0</span>;</span><br><span class="line">		sampler.MaxAnisotropy = <span class="number">0</span>;</span><br><span class="line">		sampler.ComparisonFunc = D3D12_COMPARISON_FUNC_NEVER;</span><br><span class="line">		sampler.BorderColor = D3D12_STATIC_BORDER_COLOR_TRANSPARENT_BLACK;</span><br><span class="line">		sampler.MinLOD = <span class="number">0.0f</span>;</span><br><span class="line">		sampler.MaxLOD = D3D12_FLOAT32_MAX;</span><br><span class="line">		sampler.ShaderRegister = <span class="number">0</span>;</span><br><span class="line">		sampler.RegisterSpace = <span class="number">0</span>;</span><br><span class="line">		sampler.ShaderVisibility = D3D12_SHADER_VISIBILITY_PIXEL;</span><br></pre></td></tr></table></figure>

<h3 id="创建根签名"><a href="#创建根签名" class="headerlink" title="创建根签名"></a>创建根签名</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CD3DX12_VERSIONED_ROOT_SIGNATURE_DESC rootSignatureDesc;</span><br><span class="line">		rootSignatureDesc.<span class="built_in">Init_1_1</span>(_countof(rootParameters), rootParameters, <span class="number">1</span>, &amp;sampler, rootSignatureFlags);</span><br><span class="line"></span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; signature;</span><br><span class="line">		ComPtr&lt;ID3DBlob&gt; error;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DX12SerializeVersionedRootSignature</span>(&amp;rootSignatureDesc, featureData.HighestVersion, &amp;signature, &amp;error));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateRootSignature</span>(<span class="number">0</span>, signature-&gt;<span class="built_in">GetBufferPointer</span>(), signature-&gt;<span class="built_in">GetBufferSize</span>(), <span class="built_in">IID_PPV_ARGS</span>(&amp;rootSignature)));</span><br></pre></td></tr></table></figure>

<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个用于根签名功能数据的结构</span></span><br><span class="line">D3D12_FEATURE_DATA_ROOT_SIGNATURE featureData = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置应用程序支持的根签名的最高版本（1.1）</span></span><br><span class="line">featureData.HighestVersion = D3D_ROOT_SIGNATURE_VERSION_1_1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查设备是否支持指定的根签名版本</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">FAILED</span>(device-&gt;<span class="built_in">CheckFeatureSupport</span>(D3D12_FEATURE_ROOT_SIGNATURE, &amp;featureData, <span class="built_in">sizeof</span>(featureData))))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果不支持，则回退到版本1.0</span></span><br><span class="line">    featureData.HighestVersion = D3D_ROOT_SIGNATURE_VERSION_1_0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义描述符范围数组和根参数数组</span></span><br><span class="line">CD3DX12_DESCRIPTOR_RANGE1 ranges[<span class="number">2</span>];</span><br><span class="line">CD3DX12_ROOT_PARAMETER1 rootParameters[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化描述符范围</span></span><br><span class="line">ranges[<span class="number">0</span>].<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_CBV, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, D3D12_DESCRIPTOR_RANGE_FLAG_DATA_STATIC);</span><br><span class="line">ranges[<span class="number">1</span>].<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_SRV, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, D3D12_DESCRIPTOR_RANGE_FLAG_DATA_STATIC);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将根参数初始化为带有两个范围（CBV 和 SRV）的描述符表</span></span><br><span class="line">rootParameters[<span class="number">0</span>].<span class="built_in">InitAsDescriptorTable</span>(<span class="number">2</span>, &amp;ranges[<span class="number">0</span>], D3D12_SHADER_VISIBILITY_ALL);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义根签名标志</span></span><br><span class="line">D3D12_ROOT_SIGNATURE_FLAGS rootSignatureFlags =</span><br><span class="line">    D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT |</span><br><span class="line">    D3D12_ROOT_SIGNATURE_FLAG_DENY_HULL_SHADER_ROOT_ACCESS |</span><br><span class="line">    D3D12_ROOT_SIGNATURE_FLAG_DENY_DOMAIN_SHADER_ROOT_ACCESS |</span><br><span class="line">    D3D12_ROOT_SIGNATURE_FLAG_DENY_GEOMETRY_SHADER_ROOT_ACCESS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义静态采样器描述</span></span><br><span class="line">D3D12_STATIC_SAMPLER_DESC sampler = &#123;&#125;;</span><br><span class="line">sampler.Filter = D3D12_FILTER_MIN_MAG_MIP_POINT;</span><br><span class="line">sampler.AddressU = D3D12_TEXTURE_ADDRESS_MODE_BORDER;</span><br><span class="line">sampler.AddressV = D3D12_TEXTURE_ADDRESS_MODE_BORDER;</span><br><span class="line">sampler.AddressW = D3D12_TEXTURE_ADDRESS_MODE_BORDER;</span><br><span class="line">sampler.MipLODBias = <span class="number">0</span>;</span><br><span class="line">sampler.MaxAnisotropy = <span class="number">0</span>;</span><br><span class="line">sampler.ComparisonFunc = D3D12_COMPARISON_FUNC_NEVER;</span><br><span class="line">sampler.BorderColor = D3D12_STATIC_BORDER_COLOR_TRANSPARENT_BLACK;</span><br><span class="line">sampler.MinLOD = <span class="number">0.0f</span>;</span><br><span class="line">sampler.MaxLOD = D3D12_FLOAT32_MAX;</span><br><span class="line">sampler.ShaderRegister = <span class="number">0</span>;</span><br><span class="line">sampler.RegisterSpace = <span class="number">0</span>;</span><br><span class="line">sampler.ShaderVisibility = D3D12_SHADER_VISIBILITY_PIXEL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化版本化的根签名描述</span></span><br><span class="line">CD3DX12_VERSIONED_ROOT_SIGNATURE_DESC rootSignatureDesc;</span><br><span class="line">rootSignatureDesc.<span class="built_in">Init_1_1</span>(_countof(rootParameters), rootParameters, <span class="number">1</span>, &amp;sampler, rootSignatureFlags);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将根签名序列化为一个数据 blob</span></span><br><span class="line">ComPtr&lt;ID3DBlob&gt; signature;</span><br><span class="line">ComPtr&lt;ID3DBlob&gt; error;</span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DX12SerializeVersionedRootSignature</span>(&amp;rootSignatureDesc, featureData.HighestVersion, &amp;signature, &amp;error));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从序列化的数据 blob 创建根签名</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateRootSignature</span>(<span class="number">0</span>, signature-&gt;<span class="built_in">GetBufferPointer</span>(), signature-&gt;<span class="built_in">GetBufferSize</span>(), <span class="built_in">IID_PPV_ARGS</span>(&amp;rootSignature)));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="顶点结构体"><a href="#顶点结构体" class="headerlink" title="顶点结构体"></a>顶点结构体</h2><p>去掉颜色，加上纹理C</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Vertex</span></span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT3 position;</span><br><span class="line">	XMFLOAT2 texCoord;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="输入布局"><a href="#输入布局" class="headerlink" title="输入布局"></a>输入布局</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D3D12_INPUT_ELEMENT_DESC inputElementDescs[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">			&#123; <span class="string">&quot;TEXCOORD&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="顶点数组-2"><a href="#顶点数组-2" class="headerlink" title="顶点数组"></a>顶点数组</h2><ul>
<li>去掉颜色，加上纹理（瞎写的纹理坐标哦）</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vertex triangleVertices[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; &#123; <span class="number">-1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">-1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; +<span class="number">1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; +<span class="number">1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">-1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; <span class="number">-1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; +<span class="number">1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125; &#125;,</span><br><span class="line">			&#123; &#123; +<span class="number">1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span> &#125;, &#123; <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125; &#125;</span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="加载图像数据"><a href="#加载图像数据" class="headerlink" title="加载图像数据"></a>加载图像数据</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">              D3D12_RESOURCE_DESC textureDesc;</span><br><span class="line"><span class="type">int</span> imageBytesPerRow;</span><br><span class="line"><span class="type">int</span> imageSize = <span class="built_in">LoadImageDataFromFile</span>(&amp;imageData, textureDesc, <span class="string">L&quot;Resources/wall.jpg&quot;</span>, imageBytesPerRow);</span><br></pre></td></tr></table></figure>

<h2 id="创建纹理资源"><a href="#创建纹理资源" class="headerlink" title="创建纹理资源"></a>创建纹理资源</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CD3DX12_HEAP_PROPERTIES heapProperties = <span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT);</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE, </span><br><span class="line">			&amp;textureDesc, </span><br><span class="line">			D3D12_RESOURCE_STATE_COPY_DEST,</span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;textureBuffer)));</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> UINT64 uploadBufferSize = <span class="built_in">GetRequiredIntermediateSize</span>(textureBuffer.<span class="built_in">Get</span>(), <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">CD3DX12_HEAP_PROPERTIES heapProperties2 = <span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD);</span><br><span class="line">		CD3DX12_RESOURCE_DESC resourceDesc = CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(uploadBufferSize);</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">			&amp;heapProperties2,</span><br><span class="line">			D3D12_HEAP_FLAG_NONE,</span><br><span class="line">			&amp;resourceDesc,</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ, </span><br><span class="line">			<span class="literal">nullptr</span>,</span><br><span class="line">			<span class="built_in">IID_PPV_ARGS</span>(&amp;textureBufferUploadHeap)));</span><br></pre></td></tr></table></figure>

<p><strong>把资源从上传堆（CPU和GPU都可以访问）拷贝到默认堆（只能GPU访问），然后对资源设置屏障（也就是这个资源干什么用的）。</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义纹理数据结构，并初始化为零</span></span><br><span class="line">D3D12_SUBRESOURCE_DATA textureData = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置纹理数据指针，指向图像数据的第一个元素</span></span><br><span class="line">textureData.pData = &amp;imageData[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置纹理数据的行间距，即每一行的字节数</span></span><br><span class="line">textureData.RowPitch = imageBytesPerRow;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置纹理数据的层间距，即整个纹理的字节数</span></span><br><span class="line">textureData.SlicePitch = imageBytesPerRow * textureDesc.Height;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用UpdateSubresources函数将纹理数据从上传堆复制到默认堆</span></span><br><span class="line"><span class="built_in">UpdateSubresources</span>(commandList.<span class="built_in">Get</span>(), textureBuffer.<span class="built_in">Get</span>(), textureBufferUploadHeap.<span class="built_in">Get</span>(), <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, &amp;textureData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义资源屏障对象，用于转换纹理缓冲区的状态</span></span><br><span class="line">CD3DX12_RESOURCE_BARRIER resBarrier = CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(textureBuffer.<span class="built_in">Get</span>(), D3D12_RESOURCE_STATE_COPY_DEST, D3D12_RESOURCE_STATE_NON_PIXEL_SHADER_RESOURCE | D3D12_RESOURCE_STATE_PIXEL_SHADER_RESOURCE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将纹理缓冲区状态转换为非像素着色器资源状态和像素着色器资源状态</span></span><br><span class="line">commandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;resBarrier);</span><br></pre></td></tr></table></figure>

<h2 id="创建着色器资源视图"><a href="#创建着色器资源视图" class="headerlink" title="创建着色器资源视图"></a>创建着色器资源视图</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义着色器资源视图描述结构体，并初始化为零</span></span><br><span class="line">D3D12_SHADER_RESOURCE_VIEW_DESC srvDesc = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置着色器资源视图描述中的成员</span></span><br><span class="line"><span class="comment">// 使用默认的着色器4分量映射</span></span><br><span class="line">srvDesc.Shader4ComponentMapping = D3D12_DEFAULT_SHADER_4_COMPONENT_MAPPING;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置纹理资源的格式与原始纹理一致</span></span><br><span class="line">srvDesc.Format = textureDesc.Format;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置视图维度为2D纹理</span></span><br><span class="line">srvDesc.ViewDimension = D3D12_SRV_DIMENSION_TEXTURE2D;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置纹理资源的Mip级别数量为1</span></span><br><span class="line">srvDesc.Texture2D.MipLevels = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取着色器资源视图描述的CPU描述符句柄</span></span><br><span class="line"><span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">cbvsrvHandle</span><span class="params">(cbvsrvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将描述符句柄偏移至正确的位置（这里假设在堆中已经有一个CBV（常量缓冲区视图））</span></span><br><span class="line">cbvsrvHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, cbvsrvDescriptorSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用设备创建着色器资源视图</span></span><br><span class="line">device-&gt;<span class="built_in">CreateShaderResourceView</span>(textureBuffer.<span class="built_in">Get</span>(), &amp;srvDesc, cbvsrvHandle);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭命令列表</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(commandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交命令列表以执行复制和状态转换操作</span></span><br><span class="line">ID3D12CommandList* ppCommandLists[] = &#123; commandList.<span class="built_in">Get</span>() &#125;;</span><br><span class="line">commandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(ppCommandLists), ppCommandLists);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="设置根签名和描述符表命令"><a href="#设置根签名和描述符表命令" class="headerlink" title="设置根签名和描述符表命令"></a>设置根签名和描述符表命令</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将命令列表与根签名关联，以便在绘制时使用正确的根签名</span></span><br><span class="line">commandList-&gt;<span class="built_in">SetGraphicsRootSignature</span>(rootSignature.<span class="built_in">Get</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将着色器资源堆（包含着色器资源视图和常量缓冲区视图）与命令列表关联，</span></span><br><span class="line"><span class="comment">// 这样在绘制时可以使用着色器资源和常量缓冲区</span></span><br><span class="line">ID3D12DescriptorHeap* ppHeaps[] = &#123; cbvsrvHeap.<span class="built_in">Get</span>() &#125;;</span><br><span class="line">commandList-&gt;<span class="built_in">SetDescriptorHeaps</span>(_countof(ppHeaps), ppHeaps);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将着色器资源堆的第一个描述符表（索引为0）绑定到图形管道的根参数（索引为0）上</span></span><br><span class="line"><span class="comment">// 这样在着色器代码中就可以使用该描述符表中的着色器资源</span></span><br><span class="line">commandList-&gt;<span class="built_in">SetGraphicsRootDescriptorTable</span>(<span class="number">0</span>, cbvsrvHeap-&gt;<span class="built_in">GetGPUDescriptorHandleForHeapStart</span>());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="修改着色器代码"><a href="#修改着色器代码" class="headerlink" title="修改着色器代码"></a>修改着色器代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Texture2D t1 : <span class="built_in">register</span>(t0);</span><br><span class="line">SamplerState s1 : <span class="built_in">register</span>(s0);</span><br><span class="line"></span><br><span class="line">cbuffer SceneConstantBuffer : <span class="built_in">register</span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 WorldViewProj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PSInput</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float2 texCoord : TEXCOORD;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PSInput <span class="title">VSMain</span><span class="params">(float4 position : POSITION, float2 texCoord : TEXCOORD)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSInput result;</span><br><span class="line"></span><br><span class="line">    result.position = <span class="built_in">mul</span>(position,WorldViewProj);</span><br><span class="line">    result.texCoord = texCoord;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PSMain</span><span class="params">(PSInput input)</span> : SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> t1.<span class="built_in">Sample</span>(s1, input.texCoord);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h2><p>我是非常满意的</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230720223522198.png" alt="image-20230720223522198"></p>
<h1 id="十一-Phong和Blinn-Phong光照模型"><a href="#十一-Phong和Blinn-Phong光照模型" class="headerlink" title="十一 Phong和Blinn-Phong光照模型"></a>十一 Phong和Blinn-Phong光照模型</h1><h2 id="Phone"><a href="#Phone" class="headerlink" title="Phone"></a>Phone</h2><h3 id="顶点结构体-1"><a href="#顶点结构体-1" class="headerlink" title="顶点结构体"></a>顶点结构体</h3><p>首先修改顶点结构体添加法线。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Vertex</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">Vertex</span>(<span class="type">float</span> x, <span class="type">float</span> y, <span class="type">float</span> z,<span class="type">float</span> nx,<span class="type">float</span> ny,<span class="type">float</span> nz, <span class="type">float</span> u, <span class="type">float</span> v) : <span class="built_in">position</span>(x, y, z), <span class="built_in">normal</span>(nx,ny,nz), <span class="built_in">texCoord</span>(u, v) &#123;&#125;</span><br><span class="line">	XMFLOAT3 position;</span><br><span class="line">	XMFLOAT3 normal;</span><br><span class="line">	XMFLOAT2 texCoord;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="顶点结构体数组"><a href="#顶点结构体数组" class="headerlink" title="顶点结构体数组"></a>顶点结构体数组</h3><p>因为每一个顶点都有自己的法线，所以咱们得使用36个顶点</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Vertex triangleVertices[] =</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// front face</span></span><br><span class="line">			&#123; <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// right side face</span></span><br><span class="line">			&#123;  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>,  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>, <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// left side face</span></span><br><span class="line">			&#123; <span class="number">-0.5f</span>,  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// back face</span></span><br><span class="line">			&#123;  <span class="number">0.5f</span>,  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>, <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>,  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// top face</span></span><br><span class="line">			&#123; <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>,  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>,  <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// bottom face</span></span><br><span class="line">			&#123;  <span class="number">0.5f</span>, <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123;  <span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;,</span><br><span class="line">			&#123; <span class="number">-0.5f</span>, <span class="number">-0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span> &#125;,</span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="常量缓存-2"><a href="#常量缓存-2" class="headerlink" title="常量缓存"></a>常量缓存</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct SceneConstantBuffer</span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT4X4 Model;</span><br><span class="line">	XMFLOAT4X4 MVP;</span><br><span class="line">	XMFLOAT3 lightColor;</span><br><span class="line">	float padding1;</span><br><span class="line">	XMFLOAT3 lightPosition;</span><br><span class="line">	float padding2;</span><br><span class="line">	XMFLOAT3 viewPosition;</span><br><span class="line">	float padding3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="顶点索引数组"><a href="#顶点索引数组" class="headerlink" title="顶点索引数组"></a>顶点索引数组</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DWORD triangleIndexs[]</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// front face</span></span><br><span class="line">			 <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="comment">// first triangle</span></span><br><span class="line">			 <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="comment">// second triangle</span></span><br><span class="line"></span><br><span class="line">			 <span class="comment">// left face</span></span><br><span class="line">			 <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="comment">// first triangle</span></span><br><span class="line">			 <span class="number">4</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="comment">// second triangle</span></span><br><span class="line"></span><br><span class="line">			 <span class="comment">// right face</span></span><br><span class="line">			 <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="comment">// first triangle</span></span><br><span class="line">			 <span class="number">8</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="comment">// second triangle</span></span><br><span class="line"></span><br><span class="line">			 <span class="comment">// back face</span></span><br><span class="line">			 <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="comment">// first triangle</span></span><br><span class="line">			 <span class="number">12</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="comment">// second triangle</span></span><br><span class="line"></span><br><span class="line">			 <span class="comment">// top face</span></span><br><span class="line">			 <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="comment">// first triangle</span></span><br><span class="line">			 <span class="number">16</span>, <span class="number">19</span>, <span class="number">17</span>, <span class="comment">// second triangle</span></span><br><span class="line"></span><br><span class="line">			 <span class="comment">// bottom face</span></span><br><span class="line">			 <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="comment">// first triangle</span></span><br><span class="line">			 <span class="number">20</span>, <span class="number">23</span>, <span class="number">21</span>, <span class="comment">// second triangle</span></span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="OnUpdate-1"><a href="#OnUpdate-1" class="headerlink" title="OnUpdate"></a>OnUpdate</h3><p>修改OnUpdate方法，去掉背景颜色更新的数据，加上光位置运动的数据，并且把Phone光照模型需要的数据通过常量缓冲传递过去。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (offset &lt;= <span class="number">3.0f</span> &amp;&amp; isOffset)</span><br><span class="line">	&#123;</span><br><span class="line">		offset += <span class="number">0.01f</span>;</span><br><span class="line">		isOffset = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		offset -= <span class="number">0.01f</span>;</span><br><span class="line">		offset &lt;= <span class="number">-3</span> ? isOffset = <span class="literal">true</span> : isOffset = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	XMVECTOR pos = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">5.0f</span>, <span class="number">-5.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">	XMVECTOR target = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">	XMVECTOR up = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	XMMATRIX v = <span class="built_in">XMMatrixLookAtLH</span>(pos, target, up);</span><br><span class="line"></span><br><span class="line">	XMMATRIX m = <span class="built_in">XMMatrixIdentity</span>();</span><br><span class="line">	XMMATRIX p = <span class="built_in">XMMatrixPerspectiveFovLH</span>(XM_PIDIV4,width/height,<span class="number">1.0f</span>,<span class="number">1000.0f</span>);</span><br><span class="line">	XMMATRIX MVP = m * v * p;</span><br><span class="line"></span><br><span class="line">	SceneConstantBuffer objConstants;</span><br><span class="line">	<span class="built_in">XMStoreFloat4x4</span>(&amp;objConstants.Model, <span class="built_in">XMMatrixTranspose</span>(m));</span><br><span class="line">	<span class="built_in">XMStoreFloat4x4</span>(&amp;objConstants.MVP, <span class="built_in">XMMatrixTranspose</span>(MVP));</span><br><span class="line">	objConstants.lightColor = &#123; <span class="number">1.0f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span> &#125;;</span><br><span class="line">	objConstants.lightPosition = &#123; <span class="number">1.0f</span>+offset, <span class="number">1.0f</span>, <span class="number">2.0f</span> &#125;;</span><br><span class="line">	objConstants.viewPosition = &#123; <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">-3.0f</span> &#125;;</span><br><span class="line">	<span class="built_in">memcpy</span>(pCbvDataBegin, &amp;objConstants, <span class="built_in">sizeof</span>(objConstants));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加命令-1"><a href="#添加命令-1" class="headerlink" title="添加命令"></a>添加命令</h3><p>颜色</p>
<pre><code>//const float clearColor[] = &#123; color[0], color[1], color[2], 1.0f &#125;;
const float clearColor[] = &#123; 0.0f, 0.0f, 0.0f, 1.0f &#125;;
</code></pre>
<h3 id="管线对象-1"><a href="#管线对象-1" class="headerlink" title="管线对象"></a>管线对象</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D3D12_INPUT_ELEMENT_DESC inputElementDescs[] =</span><br><span class="line">		&#123;</span><br><span class="line">			&#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">			&#123; <span class="string">&quot;NORMAL&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">			&#123; <span class="string">&quot;TEXCOORD&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32_FLOAT, <span class="number">0</span>, <span class="number">24</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;<span class="comment">//记得变为24；</span></span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="着色器-1"><a href="#着色器-1" class="headerlink" title="着色器"></a>着色器</h3><p>修改着色器，完成咱们的Phone着色模型，这里需要注意一个点，那就是法线。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Texture2D t1 : <span class="built_in">register</span>(t0);</span><br><span class="line">SamplerState s1 : <span class="built_in">register</span>(s0);</span><br><span class="line"></span><br><span class="line">cbuffer SceneConstantBuffer : <span class="built_in">register</span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 Model;</span><br><span class="line">    float4x4 MVP;</span><br><span class="line">    float3 lightColor;</span><br><span class="line">    float3 lightPosition;</span><br><span class="line">    float3 viewPosition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PSInput</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float2 texCoord : TEXCOORD;</span><br><span class="line">    float3 normal : NORMAL;</span><br><span class="line">    float4 worldPosition : POSITION;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PSInput <span class="title">VSMain</span><span class="params">(float4 position : POSITION, float3 normal : NORMAL, float2 texCoord : TEXCOORD)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSInput result;</span><br><span class="line"></span><br><span class="line">    result.worldPosition = <span class="built_in">mul</span>(position, Model);</span><br><span class="line">    result.position = <span class="built_in">mul</span>(position, MVP);</span><br><span class="line">    result.texCoord = texCoord;</span><br><span class="line">    result.normal = normal; <span class="comment">//如果物体进行了非等比缩放，这里需要对法线进行模型矩阵左上角的逆矩阵的转置矩阵变换。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PSMain</span><span class="params">(PSInput input)</span> : SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    float4 color = t1.<span class="built_in">Sample</span>(s1, input.texCoord);</span><br><span class="line">    <span class="comment">//ambient</span></span><br><span class="line">    <span class="type">float</span> ambientStrength = <span class="number">0.1</span>;</span><br><span class="line">    float3 ambient = <span class="built_in">mul</span>(ambientStrength, lightColor);</span><br><span class="line">  	</span><br><span class="line">    <span class="comment">// diffuse </span></span><br><span class="line">    float3 norm = <span class="built_in">normalize</span>(input.normal);</span><br><span class="line">    float3 lightDir = <span class="built_in">normalize</span>(lightPosition - viewPosition);</span><br><span class="line">    <span class="type">float</span> diff = <span class="built_in">max</span>(<span class="built_in">dot</span>(norm, lightDir), <span class="number">0.0</span>);</span><br><span class="line">    float3 diffuse = <span class="built_in">mul</span>(diff, lightColor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// specular</span></span><br><span class="line">    <span class="type">float</span> specularStrength = <span class="number">0.5</span>;</span><br><span class="line">    float3 viewDir = <span class="built_in">normalize</span>(viewPosition - input.worldPosition.xyz);</span><br><span class="line">    float3 reflectDir = <span class="built_in">reflect</span>(-lightDir, norm);</span><br><span class="line">    <span class="type">float</span> spec = <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(viewDir, reflectDir), <span class="number">0.0</span>), <span class="number">32</span>);</span><br><span class="line">    float3 specular = <span class="built_in">mul</span>(<span class="built_in">mul</span>(specularStrength, spec), lightColor);</span><br><span class="line">        </span><br><span class="line">    color = <span class="built_in">mul</span>((ambient + diffuse + specular), color.xyz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Blinn-Phong"><a href="#Blinn-Phong" class="headerlink" title="Blinn-Phong"></a>Blinn-Phong</h2><p>其实Blinn-Phong和Phong效果差不多，就是提升了点性能。</p>
<p>其他东西都不变，着色器修改一下反射光部分就可以了。</p>
<h3 id="着色器代码"><a href="#着色器代码" class="headerlink" title="着色器代码"></a>着色器代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Texture2D t1 : <span class="built_in">register</span>(t0);</span><br><span class="line">SamplerState s1 : <span class="built_in">register</span>(s0);</span><br><span class="line"></span><br><span class="line">cbuffer SceneConstantBuffer : <span class="built_in">register</span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 Model;</span><br><span class="line">    float4x4 MVP;</span><br><span class="line">    float3 lightColor;</span><br><span class="line">    float3 lightPosition;</span><br><span class="line">    float3 viewPosition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PSInput</span></span><br><span class="line">&#123;</span><br><span class="line">    float4 position : SV_POSITION;</span><br><span class="line">    float2 texCoord : TEXCOORD;</span><br><span class="line">    float3 normal : NORMAL;</span><br><span class="line">    float4 worldPosition : POSITION;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PSInput <span class="title">VSMain</span><span class="params">(float4 position : POSITION, float3 normal : NORMAL, float2 texCoord : TEXCOORD)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSInput result;</span><br><span class="line"></span><br><span class="line">    result.worldPosition = <span class="built_in">mul</span>(position, Model);</span><br><span class="line">    result.position = <span class="built_in">mul</span>(position, MVP);</span><br><span class="line">    result.texCoord = texCoord;</span><br><span class="line">    result.normal = normal; <span class="comment">//如果物体进行了非等比缩放，这里需要对法线进行模型矩阵左上角的逆矩阵的转置矩阵变换。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PSMain</span><span class="params">(PSInput input)</span> : SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    float4 color = t1.<span class="built_in">Sample</span>(s1, input.texCoord);</span><br><span class="line">    <span class="comment">//ambient</span></span><br><span class="line">    <span class="type">float</span> ambientStrength = <span class="number">0.1</span>;</span><br><span class="line">    float3 ambient = <span class="built_in">mul</span>(ambientStrength, lightColor);</span><br><span class="line">  	</span><br><span class="line">    <span class="comment">// diffuse </span></span><br><span class="line">    float3 norm = <span class="built_in">normalize</span>(input.normal);</span><br><span class="line">    float3 lightDir = <span class="built_in">normalize</span>(lightPosition - viewPosition);</span><br><span class="line">    <span class="type">float</span> diff = <span class="built_in">max</span>(<span class="built_in">dot</span>(norm, lightDir), <span class="number">0.0</span>);</span><br><span class="line">    float3 diffuse = <span class="built_in">mul</span>(diff, lightColor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// specular</span></span><br><span class="line">    <span class="type">float</span> specularStrength = <span class="number">0.5</span>;</span><br><span class="line">    float3 viewDir = <span class="built_in">normalize</span>(viewPosition - input.worldPosition.xyz);</span><br><span class="line">    <span class="comment">//float3 reflectDir = reflect(-lightDir, norm);</span></span><br><span class="line">    float3 H = <span class="built_in">normalize</span>(lightDir + viewDir);</span><br><span class="line">    <span class="type">float</span> spec = <span class="built_in">pow</span>(<span class="built_in">max</span>(<span class="built_in">dot</span>(H, norm), <span class="number">0.0</span>), <span class="number">32</span>);</span><br><span class="line">    float3 specular = <span class="built_in">mul</span>(<span class="built_in">mul</span>(specularStrength, spec), lightColor);</span><br><span class="line">        </span><br><span class="line">    color = <span class="built_in">mul</span>((ambient + diffuse + specular), color.xyz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="成果-1"><a href="#成果-1" class="headerlink" title="成果"></a>成果</h2><p><img data-src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/image-20230722124204513.png" alt="image-20230722124204513"></p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Graphics/" rel="tag"><i class="fa fa-tag"></i> Graphics</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/sfmstage01.html" rel="prev" title="三维重建SFM-stage-1特征匹配">
      <i class="fa fa-chevron-left"></i> 三维重建SFM-stage-1特征匹配
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80-%E8%B0%83%E7%94%A8D3D12%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4%E5%92%8C%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">一 调用D3D12的基本步骤和准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%95%E7%94%A8%E5%BA%93%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">头文件和引用库文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B-COM"><span class="nav-number">2.1.1.</span> <span class="nav-text">组件对象模型 COM</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%BE%85%E6%B8%B2%E6%9F%93%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%88%E4%B8%89%E8%A7%92%E5%BD%A2%EF%BC%89"><span class="nav-number">2.2.</span> <span class="nav-text">定义待渲染数据结构（三角形）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="nav-number">2.3.</span> <span class="nav-text">定义变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C-%E5%88%9B%E5%BB%BA%E7%AA%97%E5%8F%A3"><span class="nav-number">3.</span> <span class="nav-text">二 创建窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#WNDCLASSEX"><span class="nav-number">3.1.</span> <span class="nav-text">WNDCLASSEX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E7%AA%97%E5%8F%A3%E5%B1%9E%E6%80%A7"><span class="nav-number">3.2.</span> <span class="nav-text">设置窗口属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CWNDCLASSEX%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">3.3.</span> <span class="nav-text">注册WNDCLASSEX结构体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Window"><span class="nav-number">3.4.</span> <span class="nav-text">Create Window</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Show-Window"><span class="nav-number">3.5.</span> <span class="nav-text">Show Window</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0While%E5%BE%AA%E7%8E%AF"><span class="nav-number">3.6.</span> <span class="nav-text">添加While循环</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%99%E7%A8%8B%E4%B8%80%E4%BA%8C%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">3.7.</span> <span class="nav-text">?教程一二完整代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">3.8.</span> <span class="nav-text">添加事件处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WindowProc-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="nav-number">3.8.1.</span> <span class="nav-text">WindowProc 回调函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8"><span class="nav-number">3.8.1.1.</span> <span class="nav-text">作用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89-%E5%88%9D%E5%A7%8B%E5%8C%96Direct3D"><span class="nav-number">4.</span> <span class="nav-text">三 初始化Direct3D</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="nav-number">4.1.</span> <span class="nav-text">基本知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%B9%E7%90%86%E6%A0%BC%E5%BC%8F"><span class="nav-number">4.1.1.</span> <span class="nav-text">纹理格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%BA%A6%E7%BC%93%E5%86%B2"><span class="nav-number">4.1.2.</span> <span class="nav-text">深度缓冲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E4%B8%8E%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">4.1.3.</span> <span class="nav-text">资源与描述符</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%84%E6%BA%90"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">描述符</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#descriptor-x3D-x3D-view"><span class="nav-number">4.1.3.2.1.</span> <span class="nav-text">descriptor&#x3D;&#x3D;view</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Descriptor%E5%85%B7%E4%BD%93%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.1.3.3.</span> <span class="nav-text">Descriptor具体类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%A0%86-Descriptor-Heap"><span class="nav-number">4.1.4.</span> <span class="nav-text">描述符堆 Descriptor Heap</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-number">4.2.</span> <span class="nav-text">全局变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%BA%BF%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.2.1.</span> <span class="nav-text">管线对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.2.2.</span> <span class="nav-text">同步对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%BA%BF%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.3.</span> <span class="nav-text">加载管线对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%85%E5%8A%A9%E6%96%B9%E6%B3%95%EF%BC%88%E5%AE%98%E6%96%B9%E6%8A%84%E6%9D%A5-%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%B7%B1%E5%86%99"><span class="nav-number">4.3.1.</span> <span class="nav-text">辅助方法（官方抄来,可以自己写)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID3D12Debug%E8%B0%83%E8%AF%95%E5%B1%82"><span class="nav-number">4.3.2.</span> <span class="nav-text">ID3D12Debug	调试层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDXGIFactory4-%E6%9E%9A%E4%B8%BE%E6%98%BE%E7%A4%BA%E9%80%82%E9%85%8D%E5%99%A8%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%BA%A4%E6%8D%A2%E9%93%BE"><span class="nav-number">4.3.3.</span> <span class="nav-text">IDXGIFactory4 枚举显示适配器，创建交换链</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IDXGIAdapter1"><span class="nav-number">4.3.3.1.</span> <span class="nav-text">IDXGIAdapter1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID3D12Device-%E5%8C%85%E5%90%AB%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="nav-number">4.3.4.</span> <span class="nav-text">ID3D12Device 包含对象创建方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID3D12CommandQueue-%E5%91%BD%E4%BB%A4%E9%98%9F%E5%88%97"><span class="nav-number">4.3.5.</span> <span class="nav-text">ID3D12CommandQueue 命令队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDXGISwapChain3-%E4%BA%A4%E6%8D%A2%E9%93%BE"><span class="nav-number">4.3.6.</span> <span class="nav-text">IDXGISwapChain3 交换链</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2%E9%93%BE%E5%92%8C%E9%A1%B5%E9%9D%A2%E7%BF%BB%E8%BD%AC"><span class="nav-number">4.3.6.1.</span> <span class="nav-text">交换链和页面翻转</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID3D12DescriptorHeap-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%A0%86"><span class="nav-number">4.3.7.</span> <span class="nav-text">ID3D12DescriptorHeap 描述符堆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID3D12Resource-%E8%B5%84%E6%BA%90"><span class="nav-number">4.3.8.</span> <span class="nav-text">ID3D12Resource 资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID3D12CommandAllocator-%E5%91%BD%E4%BB%A4%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-number">4.3.9.</span> <span class="nav-text">ID3D12CommandAllocator 命令分配器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadPipeline%E6%96%B9%E6%B3%95%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">4.3.10.</span> <span class="nav-text">LoadPipeline方法完整代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.4.</span> <span class="nav-text">加载资源对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5"><span class="nav-number">4.5.</span> <span class="nav-text">同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93"><span class="nav-number">4.6.</span> <span class="nav-text">渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93-1"><span class="nav-number">4.7.</span> <span class="nav-text">渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WindowProc"><span class="nav-number">4.8.</span> <span class="nav-text">WindowProc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Main%E5%87%BD%E6%95%B0%E4%B9%9F%E8%A6%81%E4%BF%AE%E6%94%B9"><span class="nav-number">4.9.</span> <span class="nav-text">Main函数也要修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B-%E8%83%8C%E6%99%AF%E9%A2%9C%E8%89%B2%E6%9B%B4%E6%96%B0"><span class="nav-number">5.</span> <span class="nav-text">四 背景颜色更新</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F-RGB%E9%A2%9C%E8%89%B2"><span class="nav-number">5.1.</span> <span class="nav-text">全局变量:RGB颜色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%85%E5%B1%8F%E9%A2%9C%E8%89%B2%E8%AE%BE%E7%BD%AE"><span class="nav-number">5.2.</span> <span class="nav-text">清屏颜色设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0Update%E5%87%BD%E6%95%B0"><span class="nav-number">5.3.</span> <span class="nav-text">添加Update函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3"><span class="nav-number">5.4.</span> <span class="nav-text">窗口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94-%E7%BB%98%E5%88%B6%E4%B8%89%E8%A7%92%E5%BD%A2"><span class="nav-number">6.</span> <span class="nav-text">五 绘制三角形</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9LoadAsset%E6%96%B9%E6%B3%95"><span class="nav-number">6.1.</span> <span class="nav-text">修改LoadAsset方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E7%AD%BE%E5%90%8D-ID3D12RootSignature"><span class="nav-number">6.2.</span> <span class="nav-text">根签名 ID3D12RootSignature</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A0%B9%E7%AD%BE%E5%90%8D%EF%BC%9F"><span class="nav-number">6.2.1.</span> <span class="nav-text">什么是根签名？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%9D%80%E8%89%B2%E5%99%A8"><span class="nav-number">6.3.</span> <span class="nav-text">第一个着色器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E6%96%B0%E7%9A%84%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88d3dcompiler-h%EF%BC%89%E5%92%8C%E5%BA%93%EF%BC%88d3dcompiler-lib%EF%BC%89%E3%80%82"><span class="nav-number">6.3.1.</span> <span class="nav-text">引入新的头文件（d3dcompiler.h）和库（d3dcompiler.lib）。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AAshader"><span class="nav-number">6.3.2.</span> <span class="nav-text">第一个shader</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shaders-hlsl"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">shaders.hlsl</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%BA%BF%E7%8A%B6%E6%80%81%E5%AF%B9%E8%B1%A1-ID3D12PipelineState"><span class="nav-number">6.4.</span> <span class="nav-text">创建管线状态对象 ID3D12PipelineState</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">6.4.1.</span> <span class="nav-text">是什么</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E7%BC%93%E5%AD%98%E5%92%8C%E9%A1%B6%E7%82%B9%E7%BC%93%E5%AD%98%E8%A7%86%E5%9B%BE"><span class="nav-number">6.5.</span> <span class="nav-text">顶点缓存和顶点缓存视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LoadAsset%E6%96%B9%E6%B3%95%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">6.6.</span> <span class="nav-text">LoadAsset方法完整代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9PopulateCommandList%E6%96%B9%E6%B3%95"><span class="nav-number">6.7.</span> <span class="nav-text">修改PopulateCommandList方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="nav-number">6.8.</span> <span class="nav-text">效果图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD-%E7%BB%98%E5%88%B6%E5%9B%9B%E8%BE%B9%E5%BD%A2"><span class="nav-number">7.</span> <span class="nav-text">六 绘制四边形</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-number">7.1.</span> <span class="nav-text">索引缓冲区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E6%95%B0%E7%BB%84"><span class="nav-number">7.2.</span> <span class="nav-text">顶点数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E7%BB%84"><span class="nav-number">7.3.</span> <span class="nav-text">索引数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E7%BC%93%E5%AD%98%E5%92%8C%E7%B4%A2%E5%BC%95%E7%BC%93%E5%AD%98"><span class="nav-number">7.4.</span> <span class="nav-text">顶点缓存和索引缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83-%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95"><span class="nav-number">8.</span> <span class="nav-text">七 深度测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%98%E5%88%B6%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%9B%9B%E8%BE%B9%E5%BD%A2%E5%91%BD%E4%BB%A4"><span class="nav-number">8.1.</span> <span class="nav-text">绘制第二个四边形命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%EF%BC%9A"><span class="nav-number">8.1.1.</span> <span class="nav-text">结果：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95"><span class="nav-number">8.2.</span> <span class="nav-text">深度测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%BA%A6%E6%A8%A1%E6%9D%BF%E5%A0%86"><span class="nav-number">8.2.1.</span> <span class="nav-text">深度模板堆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AE%A1%E7%BA%BF%E7%8A%B6%E6%80%81%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%90%AF%E7%94%A8%E6%B7%B1%E5%BA%A6%E6%A8%A1%E6%9D%BF"><span class="nav-number">8.2.2.</span> <span class="nav-text">修改管线状态对象，启用深度模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%BA%A6%E7%BC%93%E5%AD%98"><span class="nav-number">8.2.3.</span> <span class="nav-text">深度缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%91%BD%E4%BB%A4"><span class="nav-number">8.2.4.</span> <span class="nav-text">添加命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB-%E5%B8%B8%E9%87%8F%E7%BC%93%E5%AD%98"><span class="nav-number">9.</span> <span class="nav-text">八 常量缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E7%BC%93%E5%AD%98%E5%8C%BA%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">9.1.</span> <span class="nav-text">常量缓存区结构体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E7%BC%93%E5%AD%98%E5%A0%86"><span class="nav-number">9.2.</span> <span class="nav-text">常量缓存堆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E7%BC%93%E5%AD%98"><span class="nav-number">9.2.1.</span> <span class="nav-text">常量缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E7%AD%BE%E5%90%8D"><span class="nav-number">9.3.</span> <span class="nav-text">根签名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E5%88%97%E8%A1%A8"><span class="nav-number">9.4.</span> <span class="nav-text">命令列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OnUpdate%E6%96%B9%E6%B3%95"><span class="nav-number">9.5.</span> <span class="nav-text">OnUpdate方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shaders-hlsl-1"><span class="nav-number">9.6.</span> <span class="nav-text">shaders.hlsl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E4%B8%80%E4%B8%AAbug"><span class="nav-number">9.7.</span> <span class="nav-text">解决一个bug</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D-%E7%BB%98%E5%88%B6%E5%BD%A9%E8%89%B2%E7%AB%8B%E6%96%B9%E4%BD%93"><span class="nav-number">10.</span> <span class="nav-text">九 绘制彩色立方体</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E6%95%B0%E7%BB%84-1"><span class="nav-number">10.1.</span> <span class="nav-text">顶点数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E7%BB%84-1"><span class="nav-number">10.2.</span> <span class="nav-text">索引数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E7%BC%93%E5%AD%98-1"><span class="nav-number">10.3.</span> <span class="nav-text">常量缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OnUpdate"><span class="nav-number">10.4.</span> <span class="nav-text">OnUpdate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E5%88%97%E8%A1%A8-1"><span class="nav-number">10.5.</span> <span class="nav-text">命令列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9D%80%E8%89%B2%E5%99%A8"><span class="nav-number">10.6.</span> <span class="nav-text">着色器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81-%E7%BA%B9%E7%90%86"><span class="nav-number">11.</span> <span class="nav-text">十 纹理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E7%BA%B9%E7%90%86%E6%96%B9%E6%B3%95"><span class="nav-number">11.1.</span> <span class="nav-text">加载纹理方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%A0%86"><span class="nav-number">11.2.</span> <span class="nav-text">创建描述符堆</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E7%AD%BE%E5%90%8D-1"><span class="nav-number">11.3.</span> <span class="nav-text">根签名</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E5%8F%82%E6%95%B0"><span class="nav-number">11.3.1.</span> <span class="nav-text">根参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E9%87%87%E6%A0%B7"><span class="nav-number">11.3.2.</span> <span class="nav-text">静态采样</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%A0%B9%E7%AD%BE%E5%90%8D"><span class="nav-number">11.3.3.</span> <span class="nav-text">创建根签名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">11.3.4.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">11.4.</span> <span class="nav-text">顶点结构体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BE%93%E5%85%A5%E5%B8%83%E5%B1%80"><span class="nav-number">11.5.</span> <span class="nav-text">输入布局</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E6%95%B0%E7%BB%84-2"><span class="nav-number">11.6.</span> <span class="nav-text">顶点数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E5%9B%BE%E5%83%8F%E6%95%B0%E6%8D%AE"><span class="nav-number">11.7.</span> <span class="nav-text">加载图像数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%B9%E7%90%86%E8%B5%84%E6%BA%90"><span class="nav-number">11.8.</span> <span class="nav-text">创建纹理资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%9D%80%E8%89%B2%E5%99%A8%E8%B5%84%E6%BA%90%E8%A7%86%E5%9B%BE"><span class="nav-number">11.9.</span> <span class="nav-text">创建着色器资源视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%A0%B9%E7%AD%BE%E5%90%8D%E5%92%8C%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">11.10.</span> <span class="nav-text">设置根签名和描述符表命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%9D%80%E8%89%B2%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="nav-number">11.11.</span> <span class="nav-text">修改着色器代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E6%9E%9C"><span class="nav-number">11.12.</span> <span class="nav-text">成果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80-Phong%E5%92%8CBlinn-Phong%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B"><span class="nav-number">12.</span> <span class="nav-text">十一 Phong和Blinn-Phong光照模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Phone"><span class="nav-number">12.1.</span> <span class="nav-text">Phone</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E7%BB%93%E6%9E%84%E4%BD%93-1"><span class="nav-number">12.1.1.</span> <span class="nav-text">顶点结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E7%BB%93%E6%9E%84%E4%BD%93%E6%95%B0%E7%BB%84"><span class="nav-number">12.1.2.</span> <span class="nav-text">顶点结构体数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E7%BC%93%E5%AD%98-2"><span class="nav-number">12.1.3.</span> <span class="nav-text">常量缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B6%E7%82%B9%E7%B4%A2%E5%BC%95%E6%95%B0%E7%BB%84"><span class="nav-number">12.1.4.</span> <span class="nav-text">顶点索引数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OnUpdate-1"><span class="nav-number">12.1.5.</span> <span class="nav-text">OnUpdate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%91%BD%E4%BB%A4-1"><span class="nav-number">12.1.6.</span> <span class="nav-text">添加命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%BA%BF%E5%AF%B9%E8%B1%A1-1"><span class="nav-number">12.1.7.</span> <span class="nav-text">管线对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9D%80%E8%89%B2%E5%99%A8-1"><span class="nav-number">12.1.8.</span> <span class="nav-text">着色器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Blinn-Phong"><span class="nav-number">12.2.</span> <span class="nav-text">Blinn-Phong</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9D%80%E8%89%B2%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="nav-number">12.2.1.</span> <span class="nav-text">着色器代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E6%9E%9C-1"><span class="nav-number">12.3.</span> <span class="nav-text">成果</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Maric"
      src="https://cdn.jsdelivr.net/gh/JcMarical/mapstorage/images/avater_2.jpg">
  <p class="site-author-name" itemprop="name">Maric</p>
  <div class="site-description" itemprop="description">街舞、音乐、摄影、Coding······追求一切美好的事物，热爱生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/JcMarical" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;JcMarical" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1109361945@qq.com" title="E-Mail → mailto:1109361945@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Maric</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">106k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">1:36</span>
</div>

<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("08/10/2021 12:00:00");//此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
    setInterval("createtime()",250);
</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span><br></span>	

<span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
</span>
<span>总访客&nbsp<span id="busuanzi_value_site_uv"></span>&nbsp人</span>
    <span class="post-meta-divider">|</span>
<span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
</span>
    <span>总访问量&nbsp<span id="busuanzi_value_site_pv"></span>&nbsp次</span>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'brEj6dmYhQz1moPle0Xp61E4-gzGzoHsz',
      appKey     : 'I8feeYzASUQuNWqeDexp9Zpd',
      placeholder: "作者看到就会及时反馈，欢迎评论哦(๑•̀ㅂ•́)و✧",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
